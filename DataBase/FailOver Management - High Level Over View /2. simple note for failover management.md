# Simple Laravel Database Failover Guide - Master, Slave & Backup

## üéØ What is Database Failover?

**Simple Explanation:**
- **Master DB** = Main database (handles INSERT, UPDATE, DELETE)
- **Slave DB** = Copy database (handles SELECT queries only)
- **Backup DB** = Emergency copy (for disaster recovery)
- **Failover** = When Master fails, Slave becomes the new Master

```
Master DB (Write) ‚Üí Slave DB (Read) ‚Üí Backup DB (Safety)
     ‚Üì                    ‚Üì                ‚Üì
   Crashes            Takes Over        Stays Ready
```

---

## üîß Step 1: Database Server Setup

### Master Database Configuration (Server 1 - IP: 192.168.1.10)
```bash
# Edit MySQL config
sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf

# Add these lines:
server-id = 1                    # Unique ID for master
log-bin = mysql-bin             # Enable logging for replication
bind-address = 0.0.0.0          # Allow external connections
```

```sql
-- Create replication user
CREATE USER 'replica'@'%' IDENTIFIED BY 'replicaPassword123';
GRANT REPLICATION SLAVE ON *.* TO 'replica'@'%';
FLUSH PRIVILEGES;

-- Check master status (SAVE THESE VALUES!)
SHOW MASTER STATUS;
-- Result: File = mysql-bin.000001, Position = 154
```

### Slave Database Configuration (Server 2 - IP: 192.168.1.20)
```bash
# Edit MySQL config
sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf

# Add these lines:
server-id = 2                    # Different ID for slave
read-only = 1                   # Make it read-only
```

```sql
-- Connect slave to master
CHANGE MASTER TO
    MASTER_HOST='192.168.1.10',
    MASTER_USER='replica',
    MASTER_PASSWORD='replicaPassword123',
    MASTER_LOG_FILE='mysql-bin.000001',
    MASTER_LOG_POS=154;

-- Start replication
START SLAVE;

-- Check if working
SHOW SLAVE STATUS\G
-- Look for: Slave_IO_Running: Yes, Slave_SQL_Running: Yes
```

### Backup Database Configuration (Server 3 - IP: 192.168.1.30)
```bash
# Same as slave configuration but with different server-id
server-id = 3
read-only = 1
```

```sql
-- Same replication setup as slave
CHANGE MASTER TO
    MASTER_HOST='192.168.1.10',
    MASTER_USER='replica',
    MASTER_PASSWORD='replicaPassword123',
    MASTER_LOG_FILE='mysql-bin.000001',
    MASTER_LOG_POS=154;

START SLAVE;
```

---

## üìù Step 2: Laravel Configuration

### .env File Setup
```env
# Master Database (for writes)
DB_MASTER_HOST=192.168.1.10
DB_MASTER_PORT=3306
DB_MASTER_DATABASE=myapp_db
DB_MASTER_USERNAME=app_user
DB_MASTER_PASSWORD=password123

# Slave Database (for reads)
DB_SLAVE_HOST=192.168.1.20
DB_SLAVE_PORT=3306
DB_SLAVE_DATABASE=myapp_db
DB_SLAVE_USERNAME=app_user
DB_SLAVE_PASSWORD=password123

# Backup Database (for emergency)
DB_BACKUP_HOST=192.168.1.30
DB_BACKUP_PORT=3306
DB_BACKUP_DATABASE=myapp_db
DB_BACKUP_USERNAME=app_user
DB_BACKUP_PASSWORD=password123
```

### config/database.php - Simple Setup
```php
<?php

return [
    'default' => env('DB_CONNECTION', 'mysql'),

    'connections' => [

        // Master Database - For Writes Only
        'mysql_master' => [
            'driver' => 'mysql',
            'host' => env('DB_MASTER_HOST', '192.168.1.10'),
            'port' => env('DB_MASTER_PORT', '3306'),
            'database' => env('DB_MASTER_DATABASE', 'myapp_db'),
            'username' => env('DB_MASTER_USERNAME', 'app_user'),
            'password' => env('DB_MASTER_PASSWORD', ''),
            'charset' => 'utf8mb4',
            'collation' => 'utf8mb4_unicode_ci',
        ],

        // Slave Database - For Reads Only
        'mysql_slave' => [
            'driver' => 'mysql',
            'host' => env('DB_SLAVE_HOST', '192.168.1.20'),
            'port' => env('DB_SLAVE_PORT', '3306'),
            'database' => env('DB_SLAVE_DATABASE', 'myapp_db'),
            'username' => env('DB_SLAVE_USERNAME', 'app_user'),
            'password' => env('DB_SLAVE_PASSWORD', ''),
            'charset' => 'utf8mb4',
            'collation' => 'utf8mb4_unicode_ci',
        ],

        // Backup Database - For Emergency
        'mysql_backup' => [
            'driver' => 'mysql',
            'host' => env('DB_BACKUP_HOST', '192.168.1.30'),
            'port' => env('DB_BACKUP_PORT', '3306'),
            'database' => env('DB_BACKUP_DATABASE', 'myapp_db'),
            'username' => env('DB_BACKUP_USERNAME', 'app_user'),
            'password' => env('DB_BACKUP_PASSWORD', ''),
            'charset' => 'utf8mb4',
            'collation' => 'utf8mb4_unicode_ci',
        ],

        // Default connection - Auto Read/Write Split
        'mysql' => [
            'read' => [
                'host' => [env('DB_SLAVE_HOST', '192.168.1.20')],
            ],
            'write' => [
                'host' => [env('DB_MASTER_HOST', '192.168.1.10')],
            ],
            'driver' => 'mysql',
            'port' => env('DB_PORT', '3306'),
            'database' => env('DB_DATABASE', 'myapp_db'),
            'username' => env('DB_USERNAME', 'app_user'),
            'password' => env('DB_PASSWORD', ''),
            'charset' => 'utf8mb4',
            'collation' => 'utf8mb4_unicode_ci',
        ],
    ],
];
```

---

## üîÑ Step 3: Using Databases in Laravel

### Simple Usage Examples

#### Reading Data (From Slave)
```php
// Method 1: Explicit slave connection
$users = DB::connection('mysql_slave')->table('users')->get();

// Method 2: Automatic (Laravel will use slave for SELECT)
$users = DB::table('users')->get();  // Goes to slave automatically
```

#### Writing Data (To Master)
```php
// Method 1: Explicit master connection
DB::connection('mysql_master')->table('users')->insert([
    'name' => 'John Doe',
    'email' => 'john@example.com'
]);

// Method 2: Automatic (Laravel will use master for INSERT/UPDATE/DELETE)
DB::table('users')->insert([
    'name' => 'John Doe',
    'email' => 'john@example.com'
]);  // Goes to master automatically
```

#### Using Models
```php
// User Model - Simple Example
class User extends Model
{
    // Read from slave
    public static function getAllUsers()
    {
        return DB::connection('mysql_slave')
            ->table('users')
            ->orderBy('created_at', 'desc')
            ->get();
    }

    // Write to master
    public static function createUser($data)
    {
        return DB::connection('mysql_master')
            ->table('users')
            ->insert($data);
    }

    // Read from backup (for reports)
    public static function getUserReports()
    {
        return DB::connection('mysql_backup')
            ->table('users')
            ->selectRaw('DATE(created_at) as date, COUNT(*) as count')
            ->groupBy('date')
            ->get();
    }
}
```

#### Controller Examples
```php
class UserController extends Controller
{
    // GET - Reading users (uses slave)
    public function index()
    {
        $users = DB::connection('mysql_slave')
            ->table('users')
            ->paginate(20);

        return response()->json($users);
    }

    // POST - Creating user (uses master)
    public function store(Request $request)
    {
        $userId = DB::connection('mysql_master')
            ->table('users')
            ->insertGetId([
                'name' => $request->name,
                'email' => $request->email,
                'created_at' => now(),
                'updated_at' => now()
            ]);

        return response()->json(['id' => $userId, 'message' => 'User created']);
    }

    // GET - Analytics (uses backup to reduce load)
    public function analytics()
    {
        $stats = DB::connection('mysql_backup')
            ->table('users')
            ->selectRaw('COUNT(*) as total_users, DATE(created_at) as date')
            ->groupBy('date')
            ->get();

        return response()->json($stats);
    }
}
```

---

## üö® Step 4: Simple Failover Management

### Check Database Health (Simple Script)
```php
// Create: app/Http/Controllers/DatabaseHealthController.php
class DatabaseHealthController extends Controller
{
    public function checkHealth()
    {
        $status = [];

        // Check Master
        try {
            DB::connection('mysql_master')->select('SELECT 1');
            $status['master'] = 'healthy';
        } catch (Exception $e) {
            $status['master'] = 'failed';
        }

        // Check Slave
        try {
            DB::connection('mysql_slave')->select('SELECT 1');
            $status['slave'] = 'healthy';
        } catch (Exception $e) {
            $status['slave'] = 'failed';
        }

        // Check Backup
        try {
            DB::connection('mysql_backup')->select('SELECT 1');
            $status['backup'] = 'healthy';
        } catch (Exception $e) {
            $status['backup'] = 'failed';
        }

        return response()->json($status);
    }
}
```

### Simple Failover Script
```bash
# Create: /usr/local/bin/simple_failover.sh
#!/bin/bash

MASTER_IP="192.168.1.10"
SLAVE_IP="192.168.1.20"
BACKUP_IP="192.168.1.30"

# Function to check if MySQL is running
check_mysql() {
    mysqladmin -h$1 -uapp_user -ppassword123 ping 2>/dev/null
    return $?
}

echo "$(date): Checking database health..."

if ! check_mysql $MASTER_IP; then
    echo "$(date): Master is DOWN! Starting failover..."
    
    if check_mysql $SLAVE_IP; then
        echo "$(date): Promoting slave to master..."
        
        # Stop replication on slave
        mysql -h$SLAVE_IP -uroot -prootpassword -e "STOP SLAVE;"
        
        # Make slave writable
        mysql -h$SLAVE_IP -uroot -prootpassword -e "SET GLOBAL read_only = OFF;"
        
        # Update Laravel .env file
        sed -i 's/DB_MASTER_HOST=192.168.1.10/DB_MASTER_HOST=192.168.1.20/' /var/www/html/.env
        sed -i 's/DB_SLAVE_HOST=192.168.1.20/DB_SLAVE_HOST=192.168.1.30/' /var/www/html/.env
        
        # Clear Laravel cache
        cd /var/www/html && php artisan config:clear
        
        echo "$(date): Failover completed! Slave is now master."
    else
        echo "$(date): Slave is also DOWN! Check backup server."
    fi
else
    echo "$(date): Master is healthy."
fi
```

```bash
# Make script executable and run every 5 minutes
chmod +x /usr/local/bin/simple_failover.sh

# Add to cron
crontab -e
# Add: */5 * * * * /usr/local/bin/simple_failover.sh >> /var/log/failover.log
```

---

## üìä Step 5: Monitor Synchronization

### Check Replication Status
```php
// Simple function to check if databases are in sync
function checkSync()
{
    try {
        // Get data from master
        $masterCount = DB::connection('mysql_master')
            ->table('users')
            ->count();

        // Get data from slave
        $slaveCount = DB::connection('mysql_slave')
            ->table('users')
            ->count();

        // Check lag
        $slaveStatus = DB::connection('mysql_slave')
            ->select('SHOW SLAVE STATUS')[0];

        $lag = $slaveStatus->Seconds_Behind_Master ?? 'Unknown';

        return [
            'master_records' => $masterCount,
            'slave_records' => $slaveCount,
            'replication_lag' => $lag . ' seconds',
            'sync_status' => ($masterCount == $slaveCount) ? 'In Sync' : 'Out of Sync'
        ];

    } catch (Exception $e) {
        return ['error' => $e->getMessage()];
    }
}

// Usage in controller
public function syncStatus()
{
    return response()->json(checkSync());
}
```

### Simple Test Script
```php
// Create: routes/web.php
Route::get('/test-db', function() {
    
    // Test write to master
    $testId = DB::connection('mysql_master')
        ->table('test_sync')
        ->insertGetId([
            'test_data' => 'sync_test_' . time(),
            'created_at' => now()
        ]);

    // Wait 2 seconds for replication
    sleep(2);

    // Check if data is on slave
    $slaveData = DB::connection('mysql_slave')
        ->table('test_sync')
        ->where('id', $testId)
        ->first();

    // Check if data is on backup
    $backupData = DB::connection('mysql_backup')
        ->table('test_sync')
        ->where('id', $testId)
        ->first();

    // Cleanup
    DB::connection('mysql_master')
        ->table('test_sync')
        ->where('id', $testId)
        ->delete();

    return [
        'master_write' => 'Success',
        'slave_sync' => $slaveData ? 'Success' : 'Failed',
        'backup_sync' => $backupData ? 'Success' : 'Failed',
        'test_id' => $testId
    ];
});
```

---

## üîß Step 6: Common Issues & Simple Fixes

### Issue 1: Replication Stopped
```sql
-- Check slave status
SHOW SLAVE STATUS\G

-- If stopped, restart it
STOP SLAVE;
START SLAVE;

-- If error, skip one bad query
STOP SLAVE;
SET GLOBAL sql_slave_skip_counter = 1;
START SLAVE;
```

### Issue 2: Slave is Behind Master
```sql
-- Check how far behind
SHOW SLAVE STATUS\G
-- Look at: Seconds_Behind_Master

-- If too far behind, restart replication
STOP SLAVE;
RESET SLAVE;
-- Reconfigure with current master position
CHANGE MASTER TO ...;
START SLAVE;
```

### Issue 3: Connection Failed
```php
// Simple connection test
function testConnection($connection)
{
    try {
        DB::connection($connection)->select('SELECT 1');
        return 'Connected';
    } catch (Exception $e) {
        return 'Failed: ' . $e->getMessage();
    }
}

// Test all connections
echo "Master: " . testConnection('mysql_master') . "\n";
echo "Slave: " . testConnection('mysql_slave') . "\n";
echo "Backup: " . testConnection('mysql_backup') . "\n";
```

---

## ‚úÖ Step 7: Quick Setup Checklist

### Database Servers Setup:
- [ ] Master: server-id=1, log-bin enabled
- [ ] Slave: server-id=2, read-only=1
- [ ] Backup: server-id=3, read-only=1
- [ ] Created replication user on master
- [ ] Connected slave to master
- [ ] Connected backup to master
- [ ] Tested `SHOW SLAVE STATUS` on both slaves

### Laravel Configuration:
- [ ] Added database connections in config/database.php
- [ ] Set up .env variables for all databases
- [ ] Tested connections with `php artisan tinker`
- [ ] Verified read operations use slave
- [ ] Verified write operations use master

### Monitoring Setup:
- [ ] Created health check script
- [ ] Set up failover script in cron
- [ ] Created sync monitoring function
- [ ] Tested manual failover process

---

## üéØ Quick Commands Reference

```bash
# Check MySQL replication status
mysql -h192.168.1.20 -uroot -p -e "SHOW SLAVE STATUS\G"

# Test Laravel database connections
php artisan tinker
>>> DB::connection('mysql_master')->select('SELECT "Master Works"');
>>> DB::connection('mysql_slave')->select('SELECT "Slave Works"');

# Manual failover (if master fails)
mysql -h192.168.1.20 -uroot -p -e "STOP SLAVE; SET GLOBAL read_only = OFF;"

# Check sync status
curl http://yourapp.com/test-db

# View failover logs
tail -f /var/log/failover.log
```

**üí° Remember: This is a simple setup. For production, add proper error handling, notifications, and monitoring tools!**
