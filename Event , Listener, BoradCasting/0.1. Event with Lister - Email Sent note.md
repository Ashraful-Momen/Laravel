# Laravel Events & Listeners - Complete Implementation Guide

## ðŸ“‹ Overview
Events and Listeners provide an observer pattern implementation in Laravel, allowing you to decouple various aspects of your application. When an event is triggered, all registered listeners will execute their logic.

**Use Case:** Send email notifications when a post is created without blocking the main request flow.

---

## ðŸŽ¯ Architecture Flow
```
User Submits Form â†’ Controller Saves Data â†’ Event Dispatched â†’ Listener Triggered â†’ Email Sent
```

---

## ðŸš€ Step-by-Step Implementation

### Step 1: Initial Setup Commands

```bash
# Generate application key
php artisan key:generate

# Clear all cached config, routes, and views
php artisan optimize:clear

# Create necessary files
php artisan make:controller PostFormController
php artisan make:migration create_posts_table --create=posts
php artisan make:model Post
php artisan make:event PostCreated
php artisan make:listener SendPostNotification --event=PostCreated

# Create queue jobs table (for async email sending)
php artisan queue:table

# Run migrations
php artisan migrate
```

---

### Step 2: Database Migration

**File:** `database/migrations/xxxx_xx_xx_create_posts_table.php`

```php
public function up()
{
    Schema::create('posts', function (Blueprint $table) {
        $table->id();
        $table->string('email');
        $table->text('message');
        $table->timestamps();
    });
}
```

---

### Step 3: Post Model

**File:** `app/Models/Post.php`

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Post extends Model
{
    use HasFactory;

    protected $fillable = ['email', 'message'];
}
```

---

### Step 4: Define Routes

**File:** `routes/web.php`

```php
<?php

use Illuminate\Support\Facades\Route;
use App\Http\Controllers\PostFormController;

Route::get('/', function () {
    return view('welcome');
});

Route::view('/post', 'post')->name('post.form');

Route::post('/post', [PostFormController::class, 'store'])
    ->name('post.store');
```

---

### Step 5: Create Event Class

**File:** `app/Events/PostCreated.php`

```php
<?php

namespace App\Events;

use Illuminate\Broadcasting\InteractsWithSockets;
use Illuminate\Broadcasting\PrivateChannel;
use Illuminate\Foundation\Events\Dispatchable;
use Illuminate\Queue\SerializesModels;

class PostCreated
{
    use Dispatchable, InteractsWithSockets, SerializesModels;

    public $postData;

    /**
     * Create a new event instance.
     *
     * @param array $postData
     * @return void
     */
    public function __construct(array $postData)
    {
        $this->postData = $postData;
    }

    /**
     * Get the channels the event should broadcast on.
     *
     * @return \Illuminate\Broadcasting\Channel|array
     */
    public function broadcastOn()
    {
        return new PrivateChannel('posts');
    }
}
```

---

### Step 6: Create Listener Class

**File:** `app/Listeners/SendPostNotification.php`

```php
<?php

namespace App\Listeners;

use App\Events\PostCreated;
use App\Mail\PostNotificationMail;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Support\Facades\Mail;

class SendPostNotification implements ShouldQueue
{
    use InteractsWithQueue;

    /**
     * Create the event listener.
     *
     * @return void
     */
    public function __construct()
    {
        //
    }

    /**
     * Handle the event.
     *
     * @param  \App\Events\PostCreated  $event
     * @return void
     */
    public function handle(PostCreated $event)
    {
        // Send email notification
        Mail::to($event->postData['email'])
            ->send(new PostNotificationMail($event->postData['message']));
    }

    /**
     * Handle a job failure (optional).
     *
     * @param  \App\Events\PostCreated  $event
     * @param  \Throwable  $exception
     * @return void
     */
    public function failed(PostCreated $event, $exception)
    {
        // Log the failure or notify admin
        \Log::error('Post notification failed', [
            'email' => $event->postData['email'],
            'error' => $exception->getMessage()
        ]);
    }
}
```

> **Note:** `implements ShouldQueue` makes the listener execute asynchronously using queues.

---

### Step 7: Register Event & Listener

**File:** `app/Providers/EventServiceProvider.php`

```php
<?php

namespace App\Providers;

use App\Events\PostCreated;
use App\Listeners\SendPostNotification;
use Illuminate\Auth\Events\Registered;
use Illuminate\Auth\Listeners\SendEmailVerificationNotification;
use Illuminate\Foundation\Support\Providers\EventServiceProvider as ServiceProvider;

class EventServiceProvider extends ServiceProvider
{
    /**
     * The event listener mappings for the application.
     *
     * @var array
     */
    protected $listen = [
        Registered::class => [
            SendEmailVerificationNotification::class,
        ],
        PostCreated::class => [
            SendPostNotification::class,
        ],
    ];

    /**
     * Register any events for your application.
     *
     * @return void
     */
    public function boot()
    {
        //
    }
}
```

---

### Step 8: Create Controller

**File:** `app/Http/Controllers/PostFormController.php`

```php
<?php

namespace App\Http\Controllers;

use App\Models\Post;
use App\Events\PostCreated;
use Illuminate\Http\Request;

class PostFormController extends Controller
{
    /**
     * Store a new post and trigger event.
     *
     * @param  \Illuminate\Http\Request  $request
     * @return \Illuminate\Http\RedirectResponse
     */
    public function store(Request $request)
    {
        // Validate incoming request
        $validated = $request->validate([
            'email' => 'required|email|max:255',
            'message' => 'required|string|max:1000',
        ]);

        // Save post to database
        $post = Post::create([
            'email' => $validated['email'],
            'message' => $validated['message'],
        ]);

        // Prepare data for event
        $postData = [
            'email' => $post->email,
            'message' => $post->message,
        ];

        // Dispatch event (triggers all registered listeners)
        event(new PostCreated($postData));

        // Redirect with success message
        return redirect()
            ->back()
            ->with('message', 'Your post has been submitted successfully! Check your email.');
    }
}
```

---

### Step 9: Create Mailable Class

**File:** `app/Mail/PostNotificationMail.php`

```php
<?php

namespace App\Mail;

use Illuminate\Bus\Queueable;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Mail\Mailable;
use Illuminate\Queue\SerializesModels;

class PostNotificationMail extends Mailable implements ShouldQueue
{
    use Queueable, SerializesModels;

    public $message;

    /**
     * Create a new message instance.
     *
     * @param string $message
     * @return void
     */
    public function __construct($message)
    {
        $this->message = $message;
    }

    /**
     * Build the message.
     *
     * @return $this
     */
    public function build()
    {
        return $this->subject('New Post Notification')
                    ->view('emails.post-notification')
                    ->with(['postMessage' => $this->message]);
    }
}
```

> **Note:** `implements ShouldQueue` on Mailable class queues the email sending process.

---

### Step 10: Create Email View

**File:** `resources/views/emails/post-notification.blade.php`

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Notification</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: #4F46E5;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 5px 5px 0 0;
        }
        .content {
            background: #f9fafb;
            padding: 30px;
            border: 1px solid #e5e7eb;
            border-radius: 0 0 5px 5px;
        }
        .message-box {
            background: white;
            padding: 20px;
            border-left: 4px solid #4F46E5;
            margin: 20px 0;
        }
        .footer {
            text-align: center;
            margin-top: 20px;
            color: #6b7280;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸŽ‰ New Post Created!</h1>
    </div>
    <div class="content">
        <p>Hello,</p>
        <p>A new post has been submitted. Here are the details:</p>
        
        <div class="message-box">
            <strong>Message:</strong>
            <p>{{ $postMessage }}</p>
        </div>

        <p>Thank you for using our platform!</p>
        <p>Best regards,<br>{{ config('app.name') }}</p>
    </div>
    <div class="footer">
        <p>&copy; {{ date('Y') }} {{ config('app.name') }}. All rights reserved.</p>
    </div>
</body>
</html>
```

---

### Step 11: Create Frontend View

**File:** `resources/views/post.blade.php`

```html
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Submit Post</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card mt-5 shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">Submit Your Post</h4>
                    </div>
                    <div class="card-body">
                        {{-- Success Message --}}
                        @if (session('message'))
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <strong>Success!</strong> {{ session('message') }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        @endif

                        {{-- Error Messages --}}
                        @if ($errors->any())
                            <div class="alert alert-danger">
                                <ul class="mb-0">
                                    @foreach ($errors->all() as $error)
                                        <li>{{ $error }}</li>
                                    @endforeach
                                </ul>
                            </div>
                        @endif

                        {{-- Form --}}
                        <form action="{{ route('post.store') }}" method="POST">
                            @csrf
                            
                            <div class="mb-3">
                                <label for="email" class="form-label">Email Address</label>
                                <input 
                                    type="email" 
                                    name="email" 
                                    class="form-control @error('email') is-invalid @enderror" 
                                    id="email"
                                    value="{{ old('email') }}"
                                    placeholder="Enter your email"
                                    required>
                                <small class="form-text text-muted">
                                    We'll send a notification to this email address.
                                </small>
                                @error('email')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>

                            <div class="mb-3">
                                <label for="message" class="form-label">Message</label>
                                <textarea 
                                    name="message" 
                                    class="form-control @error('message') is-invalid @enderror" 
                                    id="message"
                                    rows="5"
                                    placeholder="Enter your message"
                                    required>{{ old('message') }}</textarea>
                                @error('message')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>

                            <button type="submit" class="btn btn-primary w-100">
                                Submit Post
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
```

---

### Step 12: Configure Mail Settings

**File:** `.env`

```env
# Application
APP_NAME="Laravel Event Demo"

# SMTP Mail Configuration
MAIL_MAILER=smtp
MAIL_HOST=business90.web-hosting.com
MAIL_PORT=587
MAIL_USERNAME=your-email@domain.com
MAIL_PASSWORD=your-password
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS="${MAIL_USERNAME}"
MAIL_FROM_NAME="${APP_NAME}"

# Queue Configuration
QUEUE_CONNECTION=database
```

> **Security Note:** Never commit `.env` file to version control. Use `.env.example` instead.

---

## ðŸ”„ Running the Queue Worker

For asynchronous email sending, run the queue worker:

```bash
# Process queue jobs continuously
php artisan queue:work

# Process queue jobs with retry logic
php artisan queue:work --tries=3

# Process jobs for specific queue
php artisan queue:work --queue=emails,default

# For development (auto-reload on code changes)
php artisan queue:listen
```

### Production Queue Setup

For production environments, use **Supervisor** to keep queue workers running:

```bash
sudo apt-get install supervisor
```

Create supervisor config: `/etc/supervisor/conf.d/laravel-worker.conf`

```ini
[program:laravel-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /path/to/your/app/artisan queue:work --sleep=3 --tries=3 --max-time=3600
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/path/to/your/app/storage/logs/worker.log
stopwaitsecs=3600
```

---

## ðŸ“Š Testing the Implementation

### 1. Test Event Dispatch
```php
// In Tinker (php artisan tinker)
event(new \App\Events\PostCreated([
    'email' => 'test@example.com',
    'message' => 'Test message'
]));
```

### 2. Check Queue Jobs
```bash
# View failed jobs
php artisan queue:failed

# Retry failed jobs
php artisan queue:retry all

# Clear failed jobs
php artisan queue:flush
```

### 3. Monitor Logs
```bash
# Watch application logs
tail -f storage/logs/laravel.log
```

---

## ðŸŽ¯ Advanced: Multiple Listeners for Single Event

You can attach multiple listeners to a single event:

```php
// EventServiceProvider.php
protected $listen = [
    PostCreated::class => [
        SendPostNotification::class,
        LogPostActivity::class,
        NotifyAdmins::class,
        UpdateStatistics::class,
    ],
];
```

Each listener will execute independently when the event fires.

---

## ðŸŽ¯ Advanced: Sending to Multiple Recipients

**Option 1: Create Multiple Listener + Mail**
```php
// Create separate listener for each recipient type
SendUserNotification::class,
SendAdminNotification::class,
SendModeratorNotification::class,
```

**Option 2: Loop in Single Listener**
```php
public function handle(PostCreated $event)
{
    $recipients = ['admin@example.com', 'moderator@example.com'];
    
    foreach ($recipients as $email) {
        Mail::to($email)->send(new PostNotificationMail($event->postData));
    }
}
```

---

## âœ… Best Practices

1. **Always validate data** before dispatching events
2. **Use queues** for time-consuming tasks (email, API calls)
3. **Keep events simple** - just carry data, no business logic
4. **Keep listeners focused** - one responsibility per listener
5. **Handle failures gracefully** with `failed()` method in listeners
6. **Use type hints** for better IDE support and error detection
7. **Log important events** for debugging and monitoring
8. **Test events** independently using `Event::fake()`

---

## ðŸ› Common Pitfalls

| Issue | Solution |
|-------|----------|
| Emails not sending | Check `.env` mail config, run `php artisan config:clear` |
| Queue not processing | Ensure queue worker is running: `php artisan queue:work` |
| Event not triggering | Verify event is registered in `EventServiceProvider` |
| Listener not executing | Check listener class namespace matches registration |
| Database errors | Run migrations: `php artisan migrate:fresh` |

---

## ðŸ“š Additional Commands

```bash
# List all registered events and listeners
php artisan event:list

# Generate event and listener together
php artisan make:event PostCreated --listener=SendPostNotification

# Clear event cache
php artisan event:clear

# Create mailable class
php artisan make:mail PostNotificationMail

# Test email sending
php artisan tinker
> Mail::raw('Test', fn($m) => $m->to('test@example.com')->subject('Test'));
```

---

## ðŸŽ“ Summary

**Events & Listeners Pattern Benefits:**
- âœ… Decouples application components
- âœ… Makes code more maintainable and testable
- âœ… Allows multiple actions for single event
- âœ… Enables asynchronous processing
- âœ… Improves application performance
- âœ… Facilitates easier feature additions

**Flow Recap:**
```
Form Submit â†’ Controller â†’ Save to DB â†’ Dispatch Event â†’ Listener Catches Event â†’ Send Email (Queued) â†’ Queue Worker Processes â†’ Email Sent
```

---

**Happy Coding! ðŸš€**
