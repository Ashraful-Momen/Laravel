# Laravel Broadcasting with Redis - Simple Setup Guide

## 📊 Full Working Process (ASCII Diagram)

```
┌─────────────┐         ┌──────────────┐         ┌─────────────┐
│   Browser   │         │   Laravel    │         │    Redis    │
│  (User A)   │         │   Backend    │         │   Server    │
└──────┬──────┘         └───────┬──────┘         └──────┬──────┘
       │                        │                       │
       │  1. Send Message       │                       │
       ├───────────────────────>│                       │
       │                        │                       │
       │                        │  2. Save to DB        │
       │                        │  ┌──────────┐         │
       │                        │─>│ Database │         │
       │                        │  └──────────┘         │
       │                        │                       │
       │                        │  3. Broadcast Event   │
       │                        ├──────────────────────>│
       │                        │    (Redis Pub/Sub)    │
       │                        │                       │
       │                        │                       │  4. Publish
       │                        │                       │  ┌────────┐
       │                        │                       ├─>│ Soketi │
       │                        │                       │  │  WS    │
       │                        │                       │  └───┬────┘
       │                        │                       │      │
       │  5. Real-time Update   │                       │      │
       │<───────────────────────┼───────────────────────┼──────┘
       │   (via WebSocket)      │                       │
       │                        │                       │
┌──────┴──────┐                 │                       │
│   Browser   │                 │                       │
│  (User B)   │<────────────────┼───────────────────────┘
└─────────────┘  6. Receive     │
                 Message         │
                                 │

FLOW:
User A → Laravel Controller → Save DB → Trigger Event → Redis Pub/Sub → 
Soketi WebSocket → User B (Real-time)
```

---

## 🚀 Quick Installation

```bash
# 1. Install Dependencies
composer require predis/predis pusher/pusher-php-server
npm install --save laravel-echo socket.io-client
npm install -g @soketi/soketi

# 2. Install Redis
# Ubuntu/Debian:
sudo apt install redis-server
sudo systemctl start redis

# macOS:
brew install redis
brew services start redis
```

---

## ⚙️ Step-by-Step Setup

### Step 1: Configure .env

```env
BROADCAST_DRIVER=pusher
QUEUE_CONNECTION=redis

REDIS_HOST=127.0.0.1
REDIS_PORT=6379

PUSHER_APP_ID=my-app
PUSHER_APP_KEY=my-key
PUSHER_APP_SECRET=my-secret
PUSHER_HOST=127.0.0.1
PUSHER_PORT=6001
PUSHER_SCHEME=http

VITE_PUSHER_APP_KEY="${PUSHER_APP_KEY}"
VITE_PUSHER_HOST=127.0.0.1
VITE_PUSHER_PORT=6001
VITE_PUSHER_SCHEME=http
```

---

### Step 2: Configure Broadcasting

**File:** `config/broadcasting.php`
```php
'pusher' => [
    'driver' => 'pusher',
    'key' => env('PUSHER_APP_KEY'),
    'secret' => env('PUSHER_APP_SECRET'),
    'app_id' => env('PUSHER_APP_ID'),
    'options' => [
        'host' => env('PUSHER_HOST', '127.0.0.1'),
        'port' => env('PUSHER_PORT', 6001),
        'scheme' => env('PUSHER_SCHEME', 'http'),
        'encrypted' => true,
        'useTLS' => false,
    ],
],
```

---

### Step 3: Enable Broadcasting Provider

**File:** `config/app.php`
```php
'providers' => [
    // Uncomment this line:
    App\Providers\BroadcastServiceProvider::class,
],
```

---

### Step 4: Create Soketi Config

**File:** `soketi.json` (root directory)
```json
{
    "debug": true,
    "port": 6001,
    "appManager": {
        "array": {
            "apps": [{
                "id": "my-app",
                "key": "my-key",
                "secret": "my-secret"
            }]
        }
    }
}
```

---

### Step 5: Database Migration

```bash
php artisan make:migration create_messages_table
```

**Migration:**
```php
Schema::create('messages', function (Blueprint $table) {
    $table->id();
    $table->string('user');
    $table->text('message');
    $table->timestamps();
});
```

```bash
php artisan migrate
```

---

### Step 6: Create Model

**File:** `app/Models/Message.php`
```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Message extends Model
{
    protected $fillable = ['user', 'message'];
}
```

---

### Step 7: Create Event

```bash
php artisan make:event MessageSent
```

**File:** `app/Events/MessageSent.php`
```php
<?php

namespace App\Events;

use App\Models\Message;
use Illuminate\Broadcasting\Channel;
use Illuminate\Broadcasting\InteractsWithSockets;
use Illuminate\Contracts\Broadcasting\ShouldBroadcast;
use Illuminate\Foundation\Events\Dispatchable;
use Illuminate\Queue\SerializesModels;

class MessageSent implements ShouldBroadcast
{
    use Dispatchable, InteractsWithSockets, SerializesModels;

    public $message;

    public function __construct(Message $message)
    {
        $this->message = $message;
    }

    public function broadcastOn()
    {
        return new Channel('chat');
    }

    public function broadcastAs()
    {
        return 'message.sent';
    }
}
```

---

### Step 8: Create Controller

```bash
php artisan make:controller ChatController
```

**File:** `app/Http/Controllers/ChatController.php`
```php
<?php

namespace App\Http\Controllers;

use App\Models\Message;
use App\Events\MessageSent;
use Illuminate\Http\Request;

class ChatController extends Controller
{
    public function index()
    {
        return view('chat', [
            'messages' => Message::latest()->take(50)->get()
        ]);
    }

    public function store(Request $request)
    {
        $validated = $request->validate([
            'user' => 'required|string|max:50',
            'message' => 'required|string|max:500',
        ]);

        $message = Message::create($validated);

        broadcast(new MessageSent($message));

        return response()->json($message);
    }
}
```

---

### Step 9: Define Routes

**File:** `routes/web.php`
```php
use App\Http\Controllers\ChatController;

Route::get('/chat', [ChatController::class, 'index']);
Route::post('/chat', [ChatController::class, 'store']);
```

**File:** `routes/channels.php`
```php
use Illuminate\Support\Facades\Broadcast;

Broadcast::channel('chat', function () {
    return true; // Public channel
});
```

---

### Step 10: Configure Laravel Echo

**File:** `resources/js/bootstrap.js`
```javascript
import axios from 'axios';
window.axios = axios;
window.axios.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
window.axios.defaults.headers.common['X-CSRF-TOKEN'] = document.querySelector('meta[name="csrf-token"]').content;

import Echo from 'laravel-echo';
import io from 'socket.io-client';

window.io = io;

window.Echo = new Echo({
    broadcaster: 'socket.io',
    host: window.location.hostname + ':6001',
});
```

---

### Step 11: Create Simple Chat View

**File:** `resources/views/chat.blade.php`
```html
<!DOCTYPE html>
<html>
<head>
    <title>Simple Chat</title>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    @vite(['resources/js/app.js'])
    <style>
        body { font-family: Arial; max-width: 600px; margin: 50px auto; }
        #messages { border: 1px solid #ddd; height: 400px; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
        .message { padding: 5px; margin: 5px 0; background: #f5f5f5; border-radius: 5px; }
        input { width: 70%; padding: 10px; }
        button { width: 25%; padding: 10px; }
    </style>
</head>
<body>
    <h1>Simple Chat</h1>
    
    <div id="messages">
        @foreach($messages as $msg)
            <div class="message">
                <strong>{{ $msg->user }}:</strong> {{ $msg->message }}
            </div>
        @endforeach
    </div>

    <form id="chatForm">
        <input type="text" id="user" placeholder="Your name" required>
        <input type="text" id="message" placeholder="Message" required>
        <button type="submit">Send</button>
    </form>

    <script>
        // Listen for new messages
        window.Echo.channel('chat')
            .listen('.message.sent', (e) => {
                const messagesDiv = document.getElementById('messages');
                const messageEl = document.createElement('div');
                messageEl.className = 'message';
                messageEl.innerHTML = `<strong>${e.message.user}:</strong> ${e.message.message}`;
                messagesDiv.appendChild(messageEl);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });

        // Send message
        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const user = document.getElementById('user').value;
            const message = document.getElementById('message').value;

            await window.axios.post('/chat', { user, message });
            
            document.getElementById('message').value = '';
        });
    </script>
</body>
</html>
```

---

### Step 12: Update Vite Config

**File:** `vite.config.js`
```javascript
import { defineConfig } from 'vite';
import laravel from 'laravel-vite-plugin';

export default defineConfig({
    plugins: [
        laravel({
            input: ['resources/js/app.js'],
            refresh: true,
        }),
    ],
});
```

**File:** `resources/js/app.js`
```javascript
import './bootstrap';
```

---

## 🏃 Running the Application

Open **4 terminal windows**:

**Terminal 1 - Laravel:**
```bash
php artisan serve
```

**Terminal 2 - Soketi:**
```bash
soketi start --config=soketi.json
```

**Terminal 3 - Queue Worker:**
```bash
php artisan queue:work
```

**Terminal 4 - Vite:**
```bash
npm run dev
```

---

## 🧪 Testing

1. Open browser: `http://localhost:8000/chat`
2. Open another browser window (incognito): `http://localhost:8000/chat`
3. Send message from first window
4. See real-time update in second window ✨

---

## 🔍 Debugging

**Check Redis:**
```bash
redis-cli ping
redis-cli monitor
```

**Check Soketi:**
```bash
curl http://localhost:6001
```

**Laravel Logs:**
```bash
tail -f storage/logs/laravel.log
```

---

## 📝 Summary

**Complete Flow:**
```
User Input → Controller → Save DB → Broadcast Event → Redis → 
Soketi → Echo → Real-time UI Update
```

**Key Files:**
- `.env` - Configuration
- `soketi.json` - WebSocket server config
- `MessageSent.php` - Event
- `ChatController.php` - Handle messages
- `chat.blade.php` - Simple UI
- `bootstrap.js` - Laravel Echo setup

**4 Services Running:**
1. Laravel Server (8000)
2. Soketi WebSocket (6001)
3. Queue Worker
4. Vite Dev Server

---

**That's it! Simple real-time chat working! 🚀**
