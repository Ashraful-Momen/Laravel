
---

# Laravel Middleware — short & sharp

`route` → `middleware` → `controller function`

---

## 1) What is middleware?

Middleware runs **before** your route/controller logic. Use it to check auth, roles, set headers, etc.

Flow:
`HTTP request` → **Global middleware** → **Route middleware (if assigned)** → `Controller` → `HTTP response`

---

## 2) Create a middleware

```bash
php artisan make:middleware WebGuard
```

File created: `app/Http/Middleware/WebGuard.php`

---

## 3) Global middleware

Add middleware to run on every request.

Edit `app/Http/Kernel.php` → `$middleware`:

```php
protected $middleware = [
    // ...
    \App\Http\Middleware\TrustProxies::class,
    \Fruitcake\Cors\HandleCors::class,
    \App\Http\Middleware\CheckForMaintenanceMode::class,
    \Illuminate\Foundation\Http\Middleware\ValidatePostSize::class,
    \App\Http\Middleware\TrimStrings::class,
    \Illuminate\Foundation\Http\Middleware\ConvertEmptyStringsToNull::class,
    // add your global middleware here if you want it for all requests
    // \App\Http\Middleware\WebGuard::class,
];
```

---

## 4) Middleware groups

Group many middleware and assign the group to routes (already used by `web` and `api`).

In `app/Http/Kernel.php` → `$middlewareGroups`:

```php
protected $middlewareGroups = [
    'web' => [
        \App\Http\Middleware\EncryptCookies::class,
        \Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class,
        \Illuminate\Session\Middleware\StartSession::class,
        \Illuminate\View\Middleware\ShareErrorsFromSession::class,
        \App\Http\Middleware\VerifyCsrfToken::class,
        \Illuminate\Routing\Middleware\SubstituteBindings::class,
    ],

    'api' => [
        'throttle:api',
        \Illuminate\Routing\Middleware\SubstituteBindings::class,
    ],

    // custom group
    'group_name_of_middlewares' => [
        \App\Http\Middleware\WebGuard::class,
        \App\Http\Middleware\AuthGuard::class,
    ],
];
```

---

## 5) Route middleware (apply per-route, can accept params)

Register short names in `app/Http/Kernel.php` → `$routeMiddleware`:

```php
protected $routeMiddleware = [
    'auth' => \App\Http\Middleware\Authenticate::class,
    // ...
    'webGuard' => \App\Http\Middleware\WebGuard::class,
    'role_test' => \App\Http\Middleware\RoleTest::class,
];
```

Use in route:

```php
Route::get('/check_user', function () {
    return "You are authorized";
})->middleware('webGuard');
```

With parameter:

```php
Route::get('/role_test', function () {
    return "Welcome, Admin!";
})->middleware('role_test:admin'); // passes 'admin' to the middleware
```

---

## 6) Example middleware (WebGuard) — session based (very small)

`app/Http/Middleware/WebGuard.php`

```php
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Session;

class WebGuard
{
    public function handle(Request $request, Closure $next)
    {
        // quick debug if needed (remove dd in production)
        // dd(Session::all());

        if (Session::has('user_id')) {
            // user logged in via session -> continue
            return $next($request);
        }

        // not authorized -> redirect or return json
        // return redirect('/login'); // for web
        return response()->json(['success' => false, 'message' => 'Not authorized'], 401);
    }
}
```

---

## 7) Example middleware with parameter (role check)

`app/Http/Middleware/RoleTest.php`

```php
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;

class RoleTest
{
    public function handle(Request $request, Closure $next, $role)
    {
        // debug: dd($role);

        if (Auth::check() && Auth::user()->user_type === $role) {
            return $next($request);
        }

        return redirect('/'); // or return response()->json([...], 403)
    }
}
```

Register as `'role_test' => \App\Http\Middleware\RoleTest::class` in `$routeMiddleware`.

Route:

```php
Route::get('/role_test', function () {
    return "Welcome, Admin!";
})->middleware('role_test:admin');
```

---

## 8) Simple test routes (session example)

Add to `routes/web.php`:

```php
Route::get('/', function () {
    return view('welcome'); // or dd('hello');
});

Route::get('/login_user', function () {
    Session::put('user_id', 1);
    return redirect('/'); // now session has user_id
});

Route::get('/logout_user', function () {
    Session::forget('user_id');
    return redirect('/');
});

Route::get('/check_user', function () {
    return "You are authorized";
})->middleware('webGuard');
```

Flow to test:

1. Visit `/check_user` → returns 401 (not authorized)
2. Visit `/login_user` → creates session
3. Visit `/check_user` again → allowed

---

## 9) Grouped routes example

```php
Route::group([
    'as' => 'childDealer.',
    'prefix' => 'childDealer',
    'namespace' => 'App\Http\Controllers\ChildDealer',
    'middleware' => ['auth', 'childDealer']
], function () {
    Route::get('dashboard', 'ChildDealerController@dashboard')->name('dashboard');
    Route::get('profile', 'ChildDealerController@profile')->name('profile');
});
```

Notes:

* `'as'` sets route name prefix (`childDealer.dashboard`)
* `'prefix'` sets URL prefix (`/childDealer/dashboard`)
* `'namespace'` points controller namespace (Laravel 8+ you may prefer `use` and full class strings)
* `'middleware'` runs middleware for the whole group

---

## 10) Handy commands

* Make middleware: `php artisan make:middleware WebGuard`
* Clear caches after changes:

  ```bash
  php artisan optimize:clear
  php artisan route:clear
  php artisan config:clear
  ```

---

## Final short checklist (sequence)

1. `php artisan make:middleware Name` → file in `app/Http/Middleware`
2. Implement `handle(Request $request, Closure $next, ...$params)`
3. Register:

   * Global → `$middleware` in `app/Http/Kernel.php` (runs on every request)
   * Group → `$middlewareGroups` (runs for routes using that group)
   * Route → `$routeMiddleware` (use per-route, can accept params)
4. Use middleware in routes or groups
5. Test (use debug `dd()` temporarily), then remove `dd()` in production
6. Run `php artisan optimize:clear` if routes/config cached

---
