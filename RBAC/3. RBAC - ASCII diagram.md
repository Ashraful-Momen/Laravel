Here's the ASCII workflow diagram showing how the custom Role & Permission system works:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    LARAVEL 12 + SANCTUM RBAC FLOW                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐    ┌──────────────┐    ┌─────────────────┐                │
│  │   CLIENT    │───▶│   API ROUTE  │───▶│   MIDDLEWARE    │                │
│  │  (Frontend) │    │  (routes.php)│    │  (Auth + Check) │                │
│  └─────────────┘    └──────────────┘    └────────┬────────┘                │
│                                                   │                         │
│  ┌─────────────┐    ┌──────────────┐             │                         │
│  │   RESPONSE  │◀───│  CONTROLLER  │◀────────────┘                         │
│  │  (JSON/View)│    │  (Business   │                                      │
│  └─────────────┘    │    Logic)    │                                      │
│                     └───────┬───────┘                                      │
│                             │                                              │
│                     ┌───────▼───────┐                                      │
│                     │    MODELS     │                                      │
│                     │  (DB Queries) │                                      │
│                     └───────┬───────┘                                      │
│                             │                                              │
│                     ┌───────▼───────┐                                      │
│                     │  DATABASE     │                                      │
│                     │  (MySQL/PGSQL)│                                      │
│                     └───────────────┘                                      │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                          DETAILED WORKFLOW                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. CLIENT REQUEST                                                          │
│     GET /api/admin/dashboard                                                │
│     Header: Authorization: Bearer {sanctum-token}                           │
│                                                                             │
│  2. SANCTUM AUTH MIDDLEWARE                                                 │
│     └─ Validates token → Gets authenticated user                            │
│                                                                             │
│  3. ROLE MIDDLEWARE CHECK (role:admin)                                      │
│     └─ Calls: auth()->user()->hasRole('admin')                              │
│        │                                                                    │
│        ├─ QUERY:                                                            │
│        │  SELECT * FROM role_user                                           │
│        │  WHERE user_id = ? AND role_id IN (                                │
│        │    SELECT id FROM roles WHERE name = 'admin'                       │
│        │  )                                                                 │
│        │                                                                    │
│        └─ Result: true/false → Allow/403                                    │
│                                                                             │
│  4. PERMISSION CHECK EXAMPLE                                                │
│     User → Role → Permissions (Many-to-Many)                                │
│                                                                             │
│     ┌──────────┐    ┌───────────┐    ┌──────────────┐                      │
│     │   USER   │────│   ROLES   │────│ PERMISSIONS  │                      │
│     │          │    │           │    │              │                      │
│     │ id: 1    │    │ id: 1     │    │ id: 1        │                      │
│     │ name:... │    │ name:admin│    │ name:edit-post│                     │
│     └──────────┘    └───────────┘    └──────────────┘                      │
│          │              │              │                                    │
│          └──────────────┼──────────────┘                                    │
│                         │                                                   │
│                 role_user table       permission_role table                  │
│                 ┌─────────────┐       ┌─────────────────┐                   │
│                 │ user_id: 1  │       │ role_id: 1      │                   │
│                 │ role_id: 1  │       │ permission_id: 1│                   │
│                 └─────────────┘       └─────────────────┘                   │
│                                                                             │
│  5. PERMISSION CHECK FLOW                                                   │
│     user->hasPermission('edit-post') →                                      │
│                                                                             │
│     SQL QUERY:                                                              │
│     SELECT EXISTS (                                                         │
│       SELECT 1 FROM role_user ru                                           │
│       INNER JOIN permission_role pr ON ru.role_id = pr.role_id              │
│       INNER JOIN permissions p ON pr.permission_id = p.id                   │
│       WHERE ru.user_id = ? AND p.name = 'edit-post'                         │
│     )                                                                       │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                         API ENDPOINT EXAMPLES                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ ASSIGN ROLE TO USER                                                 │   │
│  │ POST /api/roles/assign-to-user                                      │   │
│  │ {                                                                   │   │
│  │   "user_id": 5,                                                     │   │
│  │   "role_id": 2                                                      │   │
│  │ }                                                                   │   │
│  │                                                                     │   │
│  │ → role_user table gets: user_id=5, role_id=2                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ ASSIGN PERMISSION TO ROLE                                           │   │
│  │ POST /api/permissions/assign-to-role                                │   │
│  │ {                                                                   │   │
│  │   "role_id": 2,                                                     │   │
│  │   "permission_id": 3                                                │   │
│  │ }                                                                   │   │
│  │                                                                     │   │
│  │ → permission_role table gets: role_id=2, permission_id=3            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ CHECK USER PERMISSIONS (For Frontend)                               │   │
│  │ GET /api/user/permissions                                           │   │
│  │ Response:                                                           │   │
│  │ {                                                                   │   │
│  │   "roles": ["admin", "editor"],                                     │   │
│  │   "permissions": ["create-post", "edit-post", "delete-user"]        │   │
│  │ }                                                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                           SEEDER INITIALIZATION                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  php artisan db:seed --class=RolePermissionSeeder                          │
│                                                                             │
│  1. Creates 'admin' role                                                    │
│  2. Creates 4 permissions                                                   │
│  3. Attaches all permissions to admin role                                  │
│  4. Assigns admin role to first user                                        │
│                                                                             │
│  Tables after seeding:                                                      │
│                                                                             │
│  roles table           permissions table                                    │
│  ┌─────┬────────┐      ┌─────┬─────────────┐                               │
│  │ id  │ name   │      │ id  │ name        │                               │
│  ├─────┼────────┤      ├─────┼─────────────┤                               │
│  │ 1   │ admin  │      │ 1   │ create-post │                               │
│  └─────┴────────┘      │ 2   │ edit-post   │                               │
│                        │ 3   │ delete-post │                               │
│  role_user table       │ 4   │ view-users  │                               │
│  ┌─────────┬────────┐  └─────┴─────────────┘                               │
│  │ user_id │ role_id│                                                      │
│  ├─────────┼────────┤  permission_role table                               │
│  │ 1       │ 1      │  ┌──────────────┬────────────────┐                  │
│  └─────────┴────────┘  │ permission_id │ role_id        │                  │
│                        ├──────────────┼────────────────┤                  │
│                        │ 1            │ 1              │                  │
│                        │ 2            │ 1              │                  │
│                        │ 3            │ 1              │                  │
│                        │ 4            │ 1              │                  │
│                        └──────────────┴────────────────┘                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## **Flow Summary:**

```
1. REQUEST → 2. SANCTUM AUTH → 3. ROLE/PERMISSION MIDDLEWARE → 4. DB CHECK → 5. GRANT/REJECT
```

## **Key Relationships:**

```
User → (role_user) → Role → (permission_role) → Permission
```

## **Check Sequence:**

```
1. hasRole('admin'):
   - Check if user has role with name 'admin'

2. hasPermission('edit-post'):
   - Check if any of user's roles have permission 'edit-post'
   - Join through: user → roles → permissions
```

## **Performance Note:**

The system uses efficient database queries with `exists()` and proper indexing. For production, add indexes:

```php
// In migrations:
$table->primary(['role_id', 'user_id']); // For role_user
$table->primary(['permission_id', 'role_id']); // For permission_role
```

This custom RBAC system gives you Spatie-like functionality with full control and no package dependencies!
