You can integrate S3 storage with your Laravel application running in Docker Swarm without modifying your existing code by configuring Laravel's filesystem. Here's how to do it:

## 1. Install AWS SDK for Laravel

Add this to your `composer.json` and rebuild your Docker image:

```bash
composer require league/flysystem-aws-s3-v3 "^3.0"
```

## 2. Configure Environment Variables

Add these to your `.env` file or Docker environment:

```env
# S3 Configuration
FILESYSTEM_DISK=s3
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
AWS_DEFAULT_REGION=your_region
AWS_BUCKET=your_bucket_name
AWS_ENDPOINT=your_s3_endpoint_url
AWS_USE_PATH_STYLE_ENDPOINT=true

# If you want public files to be accessible via S3 URL
AWS_URL=https://your_bucket_name.your_s3_endpoint.com
```

## 3. Update Filesystem Configuration

Modify `config/filesystems.php`:

```php
'default' => env('FILESYSTEM_DISK', 's3'),

'disks' => [
    // ... existing disks

    's3' => [
        'driver' => 's3',
        'key' => env('AWS_ACCESS_KEY_ID'),
        'secret' => env('AWS_SECRET_ACCESS_KEY'),
        'region' => env('AWS_DEFAULT_REGION'),
        'bucket' => env('AWS_BUCKET'),
        'endpoint' => env('AWS_ENDPOINT'),
        'use_path_style_endpoint' => env('AWS_USE_PATH_STYLE_ENDPOINT', false),
        'throw' => false,
        'root' => '', // Optional: add a folder prefix
        'url' => env('AWS_URL'),
    ],

    // For public files (if you want them accessible via URL)
    's3_public' => [
        'driver' => 's3',
        'key' => env('AWS_ACCESS_KEY_ID'),
        'secret' => env('AWS_SECRET_ACCESS_KEY'),
        'region' => env('AWS_DEFAULT_REGION'),
        'bucket' => env('AWS_BUCKET'),
        'endpoint' => env('AWS_ENDPOINT'),
        'use_path_style_endpoint' => env('AWS_USE_PATH_STYLE_ENDPOINT', false),
        'throw' => false,
        'root' => 'public',
        'url' => env('AWS_URL'),
        'visibility' => 'public',
    ],
],
```

## 4. Configure Logging to S3 (Optional)

If you want logs in S3, update `config/logging.php`:

```php
'channels' => [
    // ... existing channels
    
    's3' => [
        'driver' => 'single',
        'path' => 's3://your_bucket_name/logs/laravel.log',
    ],
    
    'stack' => [
        'driver' => 'stack',
        'channels' => ['single', 's3'], // Add s3 to stack
        'ignore_exceptions' => false,
    ],
],
```

## 5. Create Helper for URL Generation

Create `app/Helpers/StorageHelper.php`:

```php
<?php

namespace App\Helpers;

use Illuminate\Support\Facades\Storage;

class StorageHelper
{
    public static function url($path)
    {
        if (config('filesystems.default') === 's3') {
            return Storage::disk('s3')->url($path);
        }
        
        return Storage::url($path);
    }
    
    public static function publicUrl($path)
    {
        if (config('filesystems.default') === 's3') {
            return Storage::disk('s3_public')->url($path);
        }
        
        return asset('storage/' . $path);
    }
}
```

## 6. Update Docker Compose (if needed)

```yaml
version: '3.8'
services:
  app:
    image: your_laravel_app
    environment:
      - FILESYSTEM_DISK=s3
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}
      - AWS_BUCKET=${AWS_BUCKET}
      - AWS_ENDPOINT=${AWS_ENDPOINT}
      - AWS_URL=${AWS_URL}
    # Remove volume mounts for storage if you want everything in S3
    # volumes:
    #   - ./storage:/var/www/storage
    #   - ./public:/var/www/public
```

## 7. Migrate Existing Files (One-time operation)

Create a command to migrate existing files:

```php
// php artisan make:command MigrateToS3

<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\File;

class MigrateToS3 extends Command
{
    protected $signature = 'storage:migrate-to-s3 {--dry-run}';
    protected $description = 'Migrate local storage files to S3';

    public function handle()
    {
        $localDisk = Storage::disk('local');
        $s3Disk = Storage::disk('s3');
        
        $directories = [
            'uploads/profile',
            'uploads/passport', 
            'uploads/nid',
            'uploads/driving_licence',
            'uploads/birth_certificate',
            // Add other directories from your code
        ];
        
        foreach ($directories as $directory) {
            if ($localDisk->exists($directory)) {
                $files = $localDisk->allFiles($directory);
                
                foreach ($files as $file) {
                    $this->info("Processing: {$file}");
                    
                    if (!$this->option('dry-run')) {
                        $content = $localDisk->get($file);
                        $s3Disk->put($file, $content);
                        $this->info("Uploaded: {$file}");
                    }
                }
            }
        }
        
        $this->info('Migration completed!');
    }
}
```

## 8. Ensure Your Views Use Storage URLs

Make sure your Blade templates use proper storage URLs:

```blade
{{-- Instead of direct paths, use: --}}
<img src="{{ Storage::url($user->avatar_original) }}" />

{{-- Or use the helper: --}}
<img src="{{ \App\Helpers\StorageHelper::url($user->avatar_original) }}" />
```

## 9. Handle Public Assets (Optional)

If you want to serve public assets (CSS, JS, images) from S3:

```php
// In your AppServiceProvider boot method
public function boot()
{
    if (config('filesystems.default') === 's3') {
        URL::forceScheme('https');
        
        // Override asset() helper to use S3
        app()->singleton('url', function () {
            return new \Illuminate\Routing\UrlGenerator(
                app('router')->getRoutes(),
                app('request'),
                config('app.asset_url') ?: config('filesystems.disks.s3.url')
            );
        });
    }
}
```

## 10. Test the Configuration

```bash
# Test file upload
php artisan tinker
>>> Storage::put('test.txt', 'Hello S3!')
>>> Storage::exists('test.txt')
>>> Storage::url('test.txt')
```

## Benefits of This Approach:

1. **No code changes** - Your existing file upload code continues to work
2. **Scalable** - Files stored in S3 instead of container storage
3. **Persistent** - Files survive container restarts/deployments
4. **CDN-ready** - S3 URLs can be cached/served via CDN
5. **Backup-friendly** - S3 handles redundancy and backups

Your existing code like:

```php
$user->avatar_original = $request->avatar_original->store('uploads/profile');
```

Will automatically use S3 without any modifications once you set `FILESYSTEM_DISK=s3`.
