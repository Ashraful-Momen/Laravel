# Complete S3 Integration Guide - Laravel Docker Swarm

## Prerequisites Completed ✓
- S3 bucket "instasure" created successfully
- S3 connection test passed
- Docker Swarm stack running

## PHASE 1: CONFIGURATION FILES

### STEP 1: Update docker-stack.yml

Replace your entire `docker-stack.yml` file:

```yaml
version: '3.8'

services:
  # Laravel App with S3 environment variables
  app:
    image: instasure-dockerized_app:latest
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    working_dir: /var/www/html
    environment:
      # Database Configuration
      - DB_CONNECTION=mysql
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_DATABASE=laravel_db
      - DB_USERNAME=laravel_user
      - DB_PASSWORD=laravel_password
      
      # Redis Configuration
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CACHE_DRIVER=redis
      - SESSION_DRIVER=redis
      
      # S3 Configuration - Brilliant S3
      - FILESYSTEM_DISK=s3
      - FILESYSTEM_DRIVER=s3
      - AWS_ACCESS_KEY_ID=YIWBL4D04XN2XK6KDD87
      - AWS_SECRET_ACCESS_KEY=Ro06JYVkWpkQKqwbAnVrjhRbnNSieIKUIqmn7ZoR
      - AWS_DEFAULT_REGION=us-east-1
      - AWS_BUCKET=instasure
      - AWS_ENDPOINT=https://s3.brilliant.com.bd
      - AWS_URL=https://s3.brilliant.com.bd/instasure
      - AWS_USE_PATH_STYLE_ENDPOINT=true
      
      # New S3 variables for Laravel filesystem config
      - S3_DRIVER=s3
      - S3_KEY=YIWBL4D04XN2XK6KDD87
      - S3_SECRET=Ro06JYVkWpkQKqwbAnVrjhRbnNSieIKUIqmn7ZoR
      - S3_REGION=us-east-1
      - S3_BUCKET=instasure
      - S3_ENDPOINT=https://s3.brilliant.com.bd
      - S3_USE_PATH_STYLE=true
      - S3_URL=https://s3.brilliant.com.bd/instasure
      
      # App Configuration
      - APP_ENV=production
      - APP_DEBUG=false
      - APP_URL=http://36.255.69.72:8080
    volumes:
      - /home/ashraful/gitlab_project/instasure-dockerized:/var/www/html
      - /home/ashraful/gitlab_project/instasure-dockerized/docker/php/local.ini:/usr/local/etc/php/conf.d/local.ini
    networks:
      - laravel_network
    depends_on:
      - mysql
      - redis

  # Nginx with proper configuration
  nginx:
    image: nginx:alpine
    deploy:
      replicas: 1
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /home/ashraful/gitlab_project/instasure-dockerized:/var/www/html
      - /home/ashraful/gitlab_project/instasure-dockerized/docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
    networks:
      - laravel_network
    depends_on:
      - app

  # MySQL - unchanged
  mysql:
    image: mysql:8.0
    deploy:
      replicas: 1
    environment:
      - MYSQL_DATABASE=laravel_db
      - MYSQL_ROOT_PASSWORD=root_password
      - MYSQL_USER=laravel_user
      - MYSQL_PASSWORD=laravel_password
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - /home/ashraful/gitlab_project/instasure-dockerized/docker/mysql/my.cnf:/etc/mysql/my.cnf
    networks:
      - laravel_network

  # Redis - unchanged
  redis:
    image: redis:7-alpine
    deploy:
      replicas: 1
    ports:
      - "6380:6379"
    volumes:
      - redis_data:/data
    networks:
      - laravel_network

  # Node.js - unchanged
  node:
    image: node:18-alpine
    deploy:
      replicas: 1
      restart_policy:
        condition: none
    working_dir: /var/www/html
    volumes:
      - /home/ashraful/gitlab_project/instasure-dockerized:/var/www/html
    networks:
      - laravel_network
    command: sh -c "npm install && npm run dev"

  # PHPMyAdmin - unchanged
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    deploy:
      replicas: 1
    environment:
      - PMA_HOST=mysql
      - PMA_PORT=3306
      - PMA_USER=root
      - PMA_PASSWORD=root_password
    ports:
      - "8081:80"
    volumes:
      - /home/ashraful/gitlab_project/instasure-dockerized/docker/phpmyadmin/uploads.ini:/usr/local/etc/php/conf.d/uploads.ini
    networks:
      - laravel_network
    depends_on:
      - mysql

volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local

networks:
  laravel_network:
    driver: overlay
    attachable: true
```

### STEP 2: Create Nginx Configuration

Create file: `/home/ashraful/gitlab_project/instasure-dockerized/docker/nginx/default.conf`

```nginx
server {
    listen 80;
    server_name localhost 36.255.69.72;
    index index.php index.html;
    error_log  /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;
    root /var/www/html/public;

    # Basic Laravel configuration
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # PHP-FPM configuration
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass app:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        
        # Increase timeouts for file uploads
        fastcgi_read_timeout 300;
        fastcgi_connect_timeout 300;
        fastcgi_send_timeout 300;
    }

    # Handle static files locally first, then S3
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        try_files $uri @s3_fallback;
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Served-By "Local-Static";
    }

    # S3 fallback for static files
    location @s3_fallback {
        proxy_pass https://s3.brilliant.com.bd/instasure/public$uri;
        proxy_ssl_verify off;
        proxy_ssl_server_name on;
        proxy_set_header Host s3.brilliant.com.bd;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header X-Served-By "S3-Fallback";
        
        # If S3 also fails, return 404
        proxy_intercept_errors on;
        error_page 404 = @final_404;
    }

    # Final 404 handler
    location @final_404 {
        return 404;
    }

    # Handle storage files from S3 with local fallback
    location ~* ^/storage/(.+)$ {
        # First try local storage
        try_files /storage/$1 @s3_storage;
        expires 1d;
        add_header Cache-Control "public, max-age=86400";
        add_header X-Served-By "Local-Storage";
    }

    # S3 storage fallback
    location @s3_storage {
        proxy_pass https://s3.brilliant.com.bd/instasure/storage/$1;
        proxy_ssl_verify off;
        proxy_ssl_server_name on;
        proxy_set_header Host s3.brilliant.com.bd;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        add_header Cache-Control "public, max-age=86400";
        add_header X-Served-By "S3-Storage";
    }

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;

    # Hide nginx version
    server_tokens off;

    # Deny access to hidden files
    location ~ /\. {
        deny all;
    }

    # File upload size
    client_max_body_size 100M;
}
```

### STEP 3: Fix PHP Configuration

Edit `/home/ashraful/gitlab_project/instasure-dockerized/docker/php/local.ini`:

```ini
upload_max_filesize=100M
post_max_size=100M
memory_limit=512M
max_execution_time=300
max_input_time=300
file_uploads=On
```

## PHASE 2: LARAVEL INTEGRATION

### STEP 4: Update Filesystem Configuration

Replace `config/filesystems.php`:

```php
<?php

return [
    'default' => env('FILESYSTEM_DRIVER', 's3'),
    'cloud' => env('FILESYSTEM_CLOUD', 's3'),

    'disks' => [
        'local' => [
            'driver' => 'local',
            'root' => storage_path('app'),
            'throw' => false,
        ],

        'public' => [
            'driver' => 'local',
            'root' => storage_path('app/public'),
            'url' => env('APP_URL').'/storage',
            'visibility' => 'public',
            'throw' => false,
        ],

        's3' => [
            'driver' => 's3',
            'key' => env('S3_KEY'),
            'secret' => env('S3_SECRET'),
            'region' => env('S3_REGION'),
            'bucket' => env('S3_BUCKET'),
            'url' => env('S3_URL'),
            'endpoint' => env('S3_ENDPOINT'),
            'use_path_style_endpoint' => env('S3_USE_PATH_STYLE', true),
            'throw' => false,
            'visibility' => 'public',
        ],
    ],

    'links' => [
        public_path('storage') => storage_path('app/public'),
    ],
];
```

### STEP 5: Create S3 Service Provider

Create `app/Providers/S3StorageServiceProvider.php`:

```php
<?php

namespace App\Providers;

use Illuminate\Support\ServiceProvider;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\Log;

class S3StorageServiceProvider extends ServiceProvider
{
    public function register(): void
    {
        //
    }

    public function boot(): void
    {
        // Add helper methods to Storage facade
        Storage::macro('uploadToS3WithFallback', function ($file, $path, $disk = 's3') {
            try {
                $s3Path = Storage::disk($disk)->putFile($path, $file);
                Log::info("File uploaded to S3: {$s3Path}");
                
                return [
                    'success' => true,
                    'path' => $s3Path,
                    'url' => Storage::disk($disk)->url($s3Path),
                    'storage' => 's3'
                ];
            } catch (\Exception $e) {
                Log::warning("S3 upload failed, using local storage: " . $e->getMessage());
                
                $localPath = Storage::disk('local')->putFile($path, $file);
                
                return [
                    'success' => true,
                    'path' => $localPath,
                    'url' => Storage::disk('public')->url($localPath),
                    'storage' => 'local',
                    'error' => $e->getMessage()
                ];
            }
        });

        Storage::macro('testS3Connection', function ($disk = 's3') {
            try {
                $testFile = 'health-check-' . time() . '.txt';
                $testContent = 'S3 connection test - ' . now();
                
                Storage::disk($disk)->put($testFile, $testContent);
                $retrieved = Storage::disk($disk)->get($testFile);
                Storage::disk($disk)->delete($testFile);
                
                return [
                    'success' => true,
                    'message' => 'S3 connection successful',
                    'test_content_match' => trim($retrieved) === trim($testContent)
                ];
            } catch (\Exception $e) {
                return [
                    'success' => false,
                    'error' => $e->getMessage(),
                    'message' => 'S3 connection failed'
                ];
            }
        });
    }
}
```

### STEP 6: Create S3 Sync Command

Create `app/Console/Commands/SyncFilesToS3.php`:

```php
<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\File;
use Illuminate\Support\Facades\Log;

class SyncFilesToS3 extends Command
{
    protected $signature = 'storage:sync-s3 
                           {--test : Test S3 connection only}
                           {--public : Sync public files}
                           {--storage : Sync storage files}
                           {--all : Sync all files}
                           {--force : Force sync even if files exist}
                           {--skip-check : Skip existence check and upload all files}';

    protected $description = 'Sync local files to S3 storage';

    public function handle()
    {
        $this->info('🚀 Starting S3 Storage Sync...');
        
        if ($this->option('test')) {
            return $this->testS3Connection();
        }
        
        $this->testS3Connection();
        
        if ($this->option('public') || $this->option('all')) {
            $this->syncPublicFiles();
        }
        
        if ($this->option('storage') || $this->option('all')) {
            $this->syncStorageFiles();
        }
        
        if (!$this->option('public') && !$this->option('storage') && !$this->option('all')) {
            $this->warn('No sync option specified. Use --public, --storage, or --all');
            $this->info('Use --test to test S3 connection only');
        }
    }
    
    private function testS3Connection()
    {
        $this->info('🔍 Testing S3 connection...');
        
        $result = Storage::testS3Connection();
        
        if ($result['success']) {
            $this->info('✅ S3 connection successful!');
            $this->line("   Content match: " . ($result['test_content_match'] ? 'Yes' : 'No'));
        } else {
            $this->error('❌ S3 connection failed!');
            $this->error("   Error: {$result['error']}");
            return 1;
        }
        
        return 0;
    }
    
    private function syncPublicFiles()
    {
        $this->info('📁 Syncing public files to S3...');
        
        $publicPath = public_path();
        $files = File::allFiles($publicPath);
        
        $bar = $this->output->createProgressBar(count($files));
        $bar->start();
        
        $synced = 0;
        $failed = 0;
        $skipCheck = $this->option('skip-check') || $this->option('force');
        
        foreach ($files as $file) {
            $relativePath = str_replace($publicPath . '/', '', $file->getPathname());
            $relativePath = str_replace(DIRECTORY_SEPARATOR, '/', $relativePath);
            $s3Path = 'public/' . $relativePath;
            
            try {
                $shouldUpload = $skipCheck;
                
                if (!$skipCheck) {
                    try {
                        $shouldUpload = !Storage::disk('s3')->exists($s3Path);
                    } catch (\Exception $e) {
                        $shouldUpload = true;
                        Log::warning("S3 existence check failed for {$s3Path}, uploading anyway");
                    }
                }
                
                if ($shouldUpload) {
                    $content = File::get($file->getPathname());
                    $result = Storage::disk('s3')->put($s3Path, $content);
                    
                    if ($result) {
                        $synced++;
                    } else {
                        $failed++;
                    }
                }
            } catch (\Exception $e) {
                $this->newLine();
                $this->error("Failed to sync: {$s3Path} - {$e->getMessage()}");
                $failed++;
            }
            
            $bar->advance();
        }
        
        $bar->finish();
        $this->newLine();
        $this->info("✅ Public files sync complete!");
        $this->line("   Synced: {$synced} files");
        $this->line("   Failed: {$failed} files");
    }
    
    private function syncStorageFiles()
    {
        $this->info('💾 Syncing storage files to S3...');
        
        $storagePath = storage_path('app/public');
        
        if (!File::exists($storagePath)) {
            $this->warn('Storage path does not exist: ' . $storagePath);
            return;
        }
        
        $files = File::allFiles($storagePath);
        
        if (empty($files)) {
            $this->info('No files found in storage/app/public');
            return;
        }
        
        $bar = $this->output->createProgressBar(count($files));
        $bar->start();
        
        $synced = 0;
        $failed = 0;
        $skipCheck = $this->option('skip-check') || $this->option('force');
        
        foreach ($files as $file) {
            $relativePath = str_replace($storagePath . '/', '', $file->getPathname());
            $relativePath = str_replace(DIRECTORY_SEPARATOR, '/', $relativePath);
            $s3Path = 'storage/' . $relativePath;
            
            try {
                $shouldUpload = $skipCheck;
                
                if (!$skipCheck) {
                    try {
                        $shouldUpload = !Storage::disk('s3')->exists($s3Path);
                    } catch (\Exception $e) {
                        $shouldUpload = true;
                    }
                }
                
                if ($shouldUpload) {
                    $content = File::get($file->getPathname());
                    $result = Storage::disk('s3')->put($s3Path, $content);
                    
                    if ($result) {
                        $synced++;
                    } else {
                        $failed++;
                    }
                }
            } catch (\Exception $e) {
                $this->newLine();
                $this->error("Failed to sync: {$s3Path} - {$e->getMessage()}");
                $failed++;
            }
            
            $bar->advance();
        }
        
        $bar->finish();
        $this->newLine();
        $this->info("✅ Storage files sync complete!");
        $this->line("   Synced: {$synced} files");
        $this->line("   Failed: {$failed} files");
    }
}
```

### STEP 7: Register Service Provider

Add to `config/app.php` providers array:

```php
'providers' => [
    // ... other providers
    App\Providers\S3StorageServiceProvider::class,
],
```

## PHASE 3: DEPLOYMENT

### STEP 8: Deploy Updated Stack

```bash
# Stop current stack
docker stack rm laravel

# Wait for cleanup
sleep 10

# Deploy new stack
docker stack deploy -c docker-stack.yml laravel

# Monitor deployment
watch docker stack services laravel
```

### STEP 9: Verify Services

```bash
# Check all services are running
docker stack services laravel

# Check specific service logs if needed
docker service logs laravel_nginx
docker service logs laravel_app
```

## PHASE 4: FILE SYNCHRONIZATION

### STEP 10: Test S3 Connection

```bash
# Enter the Laravel container
docker exec -it $(docker ps -q -f name=laravel_app) bash

# Test S3 connection
php artisan storage:sync-s3 --test
```

### STEP 11: Sync Public Files

```bash
# Sync all public files to S3
php artisan storage:sync-s3 --public --skip-check
```

### STEP 12: Create and Sync Storage Files

```bash
# Create test storage files
mkdir -p storage/app/public/test-uploads
echo "Test storage file" > storage/app/public/test-file.txt

# Sync storage files
php artisan storage:sync-s3 --storage --skip-check
```

## PHASE 5: TESTING & VERIFICATION

### STEP 13: Test Direct S3 Access

```bash
# Test S3 URLs directly
curl -I https://s3.brilliant.com.bd/instasure/public/1.php
curl -I https://s3.brilliant.com.bd/instasure/storage/test-file.txt
```

### STEP 14: Test Website Access

Visit these URLs in browser:
- `http://36.255.69.72:8080` (main website)
- `http://36.255.69.72:8080/storage/test-file.txt` (storage file)

### STEP 15: Verify File Counts

```bash
php artisan tinker
```

```php
// Check file counts in S3
$publicFiles = Storage::disk('s3')->files('public');
echo "Public files in S3: " . count($publicFiles) . "\n";

$storageFiles = Storage::disk('s3')->files('storage');
echo "Storage files in S3: " . count($storageFiles) . "\n";

// Test specific file existence
$exists = Storage::disk('s3')->exists('public/1.php');
echo "Sample file exists: " . ($exists ? 'Yes' : 'No') . "\n";

exit
```

## PHASE 6: MONITORING & MAINTENANCE

### STEP 16: Set Up Monitoring

```bash
# Add to crontab for regular S3 health checks
echo "0 */6 * * * cd /var/www/html && php artisan storage:sync-s3 --test" | crontab -
```

### STEP 17: Backup Strategy

Your setup now provides:
- **Primary storage**: S3 (scalable, reliable)
- **Fallback storage**: Local files (immediate availability)
- **Automatic failover**: Nginx serves local files if S3 is unavailable

## TROUBLESHOOTING COMMANDS

If issues arise:

```bash
# Clear Laravel caches
php artisan config:clear
php artisan cache:clear

# Check Laravel logs
tail -f storage/logs/laravel.log

# Check nginx logs
docker service logs laravel_nginx

# Test individual file upload
php artisan tinker
Storage::disk('s3')->put('test.txt', 'test content');
exit
```

## FINAL VERIFICATION

Your S3 integration is complete when:
1. ✅ All services show 1/1 replicas in `docker stack services laravel`
2. ✅ S3 connection test passes
3. ✅ Public files uploaded to S3
4. ✅ Website loads properly from `http://36.255.69.72:8080`
5. ✅ Files accessible via both local and S3 URLs

Your Laravel application now serves files from Brilliant S3 with local fallback for maximum reliability and performance.
