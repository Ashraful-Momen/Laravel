I see the issue! The S3 connection works, but there's a problem with checking file existence on your custom S3 endpoint. The "Content match: No" and "Unable to check existence" errors indicate the S3 configuration needs adjustment.

## STEP 1: Fix the S3 Sync Command

First, let's update the sync command to handle the custom S3 endpoint better. Replace the content of `app/Console/Commands/SyncFilesToS3.php`:

```php
<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\File;
use Illuminate\Support\Facades\Log;

class SyncFilesToS3 extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'storage:sync-s3 
                           {--test : Test S3 connection only}
                           {--public : Sync public files}
                           {--storage : Sync storage files}
                           {--all : Sync all files}
                           {--force : Force sync even if files exist}
                           {--skip-check : Skip existence check and upload all files}';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'Sync local files to S3 storage';

    /**
     * Execute the console command.
     */
    public function handle()
    {
        $this->info('🚀 Starting S3 Storage Sync...');
        
        // Test S3 connection first
        if ($this->option('test')) {
            return $this->testS3Connection();
        }
        
        $this->testS3Connection();
        
        if ($this->option('public') || $this->option('all')) {
            $this->syncPublicFiles();
        }
        
        if ($this->option('storage') || $this->option('all')) {
            $this->syncStorageFiles();
        }
        
        if (!$this->option('public') && !$this->option('storage') && !$this->option('all')) {
            $this->warn('No sync option specified. Use --public, --storage, or --all');
            $this->info('Use --test to test S3 connection only');
        }
    }
    
    private function testS3Connection()
    {
        $this->info('🔍 Testing S3 connection...');
        
        try {
            $testFile = 'health-check-' . time() . '.txt';
            $testContent = 'S3 connection test - ' . now();
            
            // Upload test file
            $uploaded = Storage::disk('s3')->put($testFile, $testContent);
            
            if ($uploaded) {
                $this->info('✅ S3 upload successful!');
                
                // Try to read it back
                try {
                    $retrieved = Storage::disk('s3')->get($testFile);
                    $contentMatch = $retrieved === $testContent;
                    $this->line("   Content match: " . ($contentMatch ? 'Yes' : 'No'));
                    
                    // Clean up
                    Storage::disk('s3')->delete($testFile);
                    
                    if ($contentMatch) {
                        $this->info('✅ S3 read/write test passed!');
                        return 0;
                    } else {
                        $this->warn('⚠️  S3 content verification failed, but upload works');
                        return 0;
                    }
                } catch (\Exception $e) {
                    $this->warn('⚠️  S3 upload works, but read failed: ' . $e->getMessage());
                    // Still try to clean up
                    try {
                        Storage::disk('s3')->delete($testFile);
                    } catch (\Exception $e2) {
                        // Ignore cleanup errors
                    }
                    return 0;
                }
            } else {
                $this->error('❌ S3 upload failed!');
                return 1;
            }
        } catch (\Exception $e) {
            $this->error('❌ S3 connection failed!');
            $this->error("   Error: {$e->getMessage()}");
            return 1;
        }
    }
    
    private function syncPublicFiles()
    {
        $this->info('📁 Syncing public files to S3...');
        
        $publicPath = public_path();
        $files = File::allFiles($publicPath);
        
        $bar = $this->output->createProgressBar(count($files));
        $bar->start();
        
        $synced = 0;
        $failed = 0;
        $skipCheck = $this->option('skip-check') || $this->option('force');
        
        foreach ($files as $file) {
            $relativePath = str_replace($publicPath . '/', '', $file->getPathname());
            $relativePath = str_replace(DIRECTORY_SEPARATOR, '/', $relativePath); // Fix Windows paths
            $s3Path = 'public/' . $relativePath;
            
            try {
                // Skip existence check if requested or if it's problematic
                $shouldUpload = $skipCheck;
                
                if (!$skipCheck) {
                    try {
                        $shouldUpload = !Storage::disk('s3')->exists($s3Path);
                    } catch (\Exception $e) {
                        // If existence check fails, upload anyway
                        $shouldUpload = true;
                        Log::warning("S3 existence check failed for {$s3Path}, uploading anyway: " . $e->getMessage());
                    }
                }
                
                if ($shouldUpload) {
                    $content = File::get($file->getPathname());
                    $result = Storage::disk('s3')->put($s3Path, $content);
                    
                    if ($result) {
                        $synced++;
                    } else {
                        $failed++;
                        Log::error("Failed to upload to S3: {$s3Path}");
                    }
                }
            } catch (\Exception $e) {
                $this->newLine();
                $this->error("Failed to sync: {$s3Path} - {$e->getMessage()}");
                $failed++;
                Log::error("S3 sync error for {$s3Path}: " . $e->getMessage());
            }
            
            $bar->advance();
        }
        
        $bar->finish();
        $this->newLine();
        $this->info("✅ Public files sync complete!");
        $this->line("   Synced: {$synced} files");
        $this->line("   Failed: {$failed} files");
    }
    
    private function syncStorageFiles()
    {
        $this->info('💾 Syncing storage files to S3...');
        
        $storagePath = storage_path('app/public');
        
        if (!File::exists($storagePath)) {
            $this->warn('Storage path does not exist: ' . $storagePath);
            return;
        }
        
        $files = File::allFiles($storagePath);
        
        if (empty($files)) {
            $this->info('No files found in storage/app/public');
            return;
        }
        
        $bar = $this->output->createProgressBar(count($files));
        $bar->start();
        
        $synced = 0;
        $failed = 0;
        $skipCheck = $this->option('skip-check') || $this->option('force');
        
        foreach ($files as $file) {
            $relativePath = str_replace($storagePath . '/', '', $file->getPathname());
            $relativePath = str_replace(DIRECTORY_SEPARATOR, '/', $relativePath); // Fix Windows paths
            $s3Path = 'storage/' . $relativePath;
            
            try {
                // Skip existence check if requested or if it's problematic
                $shouldUpload = $skipCheck;
                
                if (!$skipCheck) {
                    try {
                        $shouldUpload = !Storage::disk('s3')->exists($s3Path);
                    } catch (\Exception $e) {
                        // If existence check fails, upload anyway
                        $shouldUpload = true;
                        Log::warning("S3 existence check failed for {$s3Path}, uploading anyway: " . $e->getMessage());
                    }
                }
                
                if ($shouldUpload) {
                    $content = File::get($file->getPathname());
                    $result = Storage::disk('s3')->put($s3Path, $content);
                    
                    if ($result) {
                        $synced++;
                    } else {
                        $failed++;
                        Log::error("Failed to upload to S3: {$s3Path}");
                    }
                }
            } catch (\Exception $e) {
                $this->newLine();
                $this->error("Failed to sync: {$s3Path} - {$e->getMessage()}");
                $failed++;
                Log::error("S3 sync error for {$s3Path}: " . $e->getMessage());
            }
            
            $bar->advance();
        }
        
        $bar->finish();
        $this->newLine();
        $this->info("✅ Storage files sync complete!");
        $this->line("   Synced: {$synced} files");
        $this->line("   Failed: {$failed} files");
    }
}
```

## STEP 2: Test with Skip Check Option

Run the sync command with the skip-check option to bypass the existence checking:

```bash
# Try syncing with skip-check option
php artisan storage:sync-s3 --public --skip-check

# Or if you want to force upload everything
php artisan storage:sync-s3 --public --force
```

## STEP 3: Test Individual File Upload

Let's test uploading a single file to verify S3 works:

```bash
# Enter the container
docker exec -it $(docker ps -q -f name=laravel_app) bash

# Create a test file and upload
echo "Test S3 upload" > /tmp/test.txt
php artisan tinker
```

Then in tinker:
```php
// Test direct upload
Storage::disk('s3')->put('test-upload.txt', 'Hello from Laravel S3!');

// Check if it was uploaded
$url = Storage::disk('s3')->url('test-upload.txt');
echo $url;

// Test retrieving it
$content = Storage::disk('s3')->get('test-upload.txt');
echo $content;

exit
```

## STEP 4: Check S3 Bucket Directly

Test if files are actually being uploaded by checking the S3 URLs directly:

```bash
# Test these URLs in your browser or with curl:
curl -I https://s3.brilliant.com.bd/instasure/test-upload.txt
curl https://s3.brilliant.com.bd/instasure/test-upload.txt
```

## STEP 5: Fix Filesystem Configuration (if needed)

If the direct upload doesn't work, let's update the S3 configuration in `config/filesystems.php`:

```php
's3' => [
    'driver' => 's3',
    'key' => env('S3_KEY'),
    'secret' => env('S3_SECRET'),
    'region' => env('S3_REGION', 'us-east-1'),
    'bucket' => env('S3_BUCKET'),
    'url' => env('S3_URL'),
    'endpoint' => env('S3_ENDPOINT'),
    'use_path_style_endpoint' => env('S3_USE_PATH_STYLE', true),
    'throw' => false,
    'visibility' => 'public',
    'options' => [
        'override_visibility_on_copy' => true,
    ],
    // Add these for custom endpoints
    'bucket_endpoint' => false,
    'calculate_md5' => true,
],
```

## STEP 6: Try the Fixed Sync Command

```bash
# Test the connection first
php artisan storage:sync-s3 --test

# If that works, try syncing with skip-check
php artisan storage:sync-s3 --public --skip-check
```

Let me know the results of these tests, and I'll help you resolve any remaining issues!
