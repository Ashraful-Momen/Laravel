Based on your current configuration, your Laravel app is **NOT running directly from S3**. Your `public` disk is still local and nginx has local fallbacks. Here's exactly what to change for full S3-direct operation:

## CURRENT PROBLEMS IN YOUR CONFIG

1. **Filesystem config**: `public` disk still uses `driver => 'local'`
2. **Nginx config**: Uses local files first with S3 as fallback
3. **Missing environment**: No direct S3 asset URLs

## EXACT CHANGES NEEDED

### STEP 1: Replace config/filesystems.php

**Replace your entire `config/filesystems.php` file:**

```php
<?php

return [
    'default' => 's3',  // Changed from env() to hardcoded
    'cloud' => 's3',    // Changed from env() to hardcoded

    'disks' => [
        'local' => [
            'driver' => 'local',
            'root' => storage_path('app'),
            'throw' => false,
        ],

        // CHANGED: Public disk now uses S3 directly
        'public' => [
            'driver' => 's3',
            'key' => env('S3_KEY'),
            'secret' => env('S3_SECRET'),
            'region' => env('S3_REGION'),
            'bucket' => env('S3_BUCKET'),
            'url' => env('S3_URL'),
            'endpoint' => env('S3_ENDPOINT'),
            'use_path_style_endpoint' => env('S3_USE_PATH_STYLE', true),
            'root' => 'storage',  // Files go to S3:/instasure/storage/
            'visibility' => 'public',
            'throw' => false,
        ],

        's3' => [
            'driver' => 's3',
            'key' => env('S3_KEY'),
            'secret' => env('S3_SECRET'),
            'region' => env('S3_REGION'),
            'bucket' => env('S3_BUCKET'),
            'url' => env('S3_URL'),
            'endpoint' => env('S3_ENDPOINT'),
            'use_path_style_endpoint' => env('S3_USE_PATH_STYLE', true),
            'throw' => false,
            'visibility' => 'public',
        ],

        's3-public' => [
            'driver' => 's3',
            'key' => env('S3_KEY'),
            'secret' => env('S3_SECRET'),
            'region' => env('S3_REGION'),
            'bucket' => env('S3_BUCKET'),
            'url' => env('S3_URL'),
            'endpoint' => env('S3_ENDPOINT'),
            'use_path_style_endpoint' => env('S3_USE_PATH_STYLE', true),
            'root' => 'public',
            'visibility' => 'public',
            'throw' => false,
        ],

        's3-storage' => [
            'driver' => 's3',
            'key' => env('S3_KEY'),
            'secret' => env('S3_SECRET'),
            'region' => env('S3_REGION'),
            'bucket' => env('S3_BUCKET'),
            'url' => env('S3_URL'),
            'endpoint' => env('S3_ENDPOINT'),
            'use_path_style_endpoint' => env('S3_USE_PATH_STYLE', true),
            'root' => 'storage',
            'visibility' => 'public',
            'throw' => false,
        ],
    ],

    // REMOVED: No local storage links for S3-direct
    'links' => [],
];
```

### STEP 2: Replace nginx default.conf

**Replace your entire nginx `default.conf` file:**

```nginx
server {
    listen 80;
    server_name localhost 36.255.69.72;
    index index.php index.html;
    error_log  /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;
    root /var/www/html/public;

    # Basic Laravel configuration
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # PHP-FPM configuration
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass app:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        
        fastcgi_read_timeout 300;
        fastcgi_connect_timeout 300;
        fastcgi_send_timeout 300;
    }

    # SERVE STORAGE FILES DIRECTLY FROM S3 (NO LOCAL FALLBACK)
    location ~* ^/storage/(.+)$ {
        proxy_pass https://s3.brilliant.com.bd/instasure/storage/$1;
        proxy_ssl_verify off;
        proxy_ssl_server_name on;
        proxy_set_header Host s3.brilliant.com.bd;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        add_header Cache-Control "public, max-age=86400";
        add_header X-Served-By "S3-Direct-Storage";
        
        # Direct S3 only - no local fallback
    }

    # SERVE STATIC ASSETS DIRECTLY FROM S3 (NO LOCAL FALLBACK)
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot|pdf|zip)$ {
        proxy_pass https://s3.brilliant.com.bd/instasure/public$uri;
        proxy_ssl_verify off;
        proxy_ssl_server_name on;
        proxy_set_header Host s3.brilliant.com.bd;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header X-Served-By "S3-Direct-Public";
        
        # Direct S3 only - no local fallback
    }

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;

    server_tokens off;
    client_max_body_size 100M;

    location ~ /\. {
        deny all;
    }
}
```

### STEP 3: Update docker-stack.yml Environment

**Add these environment variables to your app service:**

```yaml
environment:
  # ... existing variables ...
  
  # Add these new S3-direct variables
  - ASSET_URL=https://s3.brilliant.com.bd/instasure/public
  - MIX_ASSET_URL=https://s3.brilliant.com.bd/instasure/public
  - STORAGE_URL=https://s3.brilliant.com.bd/instasure/storage
```

### STEP 4: Deploy and Test

```bash
# Stop current stack
docker stack rm laravel

# Wait for cleanup
sleep 10

# Deploy S3-direct configuration
docker stack deploy -c docker-stack.yml laravel

# Wait for all services
watch docker stack services laravel
```

### STEP 5: Verify S3-Direct Configuration

```bash
# Enter container
docker exec -it $(docker ps -q -f name=laravel_app) bash

# Test S3-direct setup
php artisan tinker
```

```php
// Verify configuration is S3-direct
echo "Default disk: " . config('filesystems.default') . "\n";
echo "Public disk driver: " . config('filesystems.disks.public.driver') . "\n";
echo "Public disk root: " . config('filesystems.disks.public.root') . "\n";

// Test file upload goes directly to S3
$result = Storage::disk('public')->put('s3-direct-test.txt', 'S3 Direct Test Content');
echo "Upload to public disk: " . ($result ? 'Success' : 'Failed') . "\n";

// Check URL is S3 URL
$url = Storage::disk('public')->url('s3-direct-test.txt');
echo "Generated URL: " . $url . "\n";

// Test default disk also uses S3
$defaultTest = Storage::put('default-s3-test.txt', 'Default disk S3 test');
echo "Default disk upload: " . ($defaultTest ? 'Success' : 'Failed') . "\n";

$defaultUrl = Storage::url('default-s3-test.txt');
echo "Default disk URL: " . $defaultUrl . "\n";

exit
```

### STEP 6: Test Direct S3 Access

```bash
# Test direct S3 URLs
curl -I https://s3.brilliant.com.bd/instasure/storage/s3-direct-test.txt
curl -I https://s3.brilliant.com.bd/instasure/default-s3-test.txt

# Test through website (should show S3-Direct headers)
curl -I http://36.255.69.72:8080/storage/s3-direct-test.txt
```

### STEP 7: Remove Local Storage Link

```bash
# Remove old storage symlink since we're S3-direct
rm -f public/storage
```

### STEP 8: Verification Commands

```bash
php artisan tinker
```

```php
// Final verification - all should be S3
$disks = ['default', 'public', 'cloud'];
foreach ($disks as $diskName) {
    $diskConfig = config("filesystems.disks." . config("filesystems.{$diskName}"));
    echo "{$diskName} disk driver: " . $diskConfig['driver'] . "\n";
}

// Test file counts in S3
$s3Files = Storage::disk('s3')->files();
$publicFiles = Storage::disk('s3')->files('public');
$storageFiles = Storage::disk('s3')->files('storage');

echo "Total S3 files: " . count($s3Files) . "\n";
echo "Public files: " . count($publicFiles) . "\n";
echo "Storage files: " . count($storageFiles) . "\n";

// Test URL generation
$testUrl = Storage::disk('public')->url('test.txt');
echo "Public disk URL format: " . $testUrl . "\n";
// Should be: https://s3.brilliant.com.bd/instasure/storage/test.txt

exit
```

## FINAL RESULT

After these changes, your Laravel app will be **fully S3-direct**:

1. **All file uploads** go directly to S3 (no local storage)
2. **Public disk** uses S3 with `/storage` root
3. **Static assets** served directly from S3 via nginx
4. **Storage files** served directly from S3 via nginx
5. **No local fallback** - pure S3 operation

Your Laravel application will then be completely S3-native with all files served from Brilliant S3.
