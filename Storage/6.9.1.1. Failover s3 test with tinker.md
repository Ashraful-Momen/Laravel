Here are the Tinker commands to test the S3 failover and local storage functionality:

## 1. First, enter Tinker:
```bash
php artisan tinker
```

## 2. Test S3 Connection:
```php
// Check if S3 is available
app(App\Services\StorageService::class)->isS3Available();

// Or using helper
smart_storage()->isS3Available();
```

## 3. Test File Storage with Different Scenarios:

### Test 1: Normal S3 Storage
```php
// Store a test file to S3 (if available)
$result = smart_storage()->store('test-s3-file.txt', 'This is a test file for S3');
echo $result ? 'Success: File stored to S3' : 'Failed to store file';
```

### Test 2: Force Local Storage (Simulate S3 Failure)
```php
// Temporarily disable S3 to test fallback
config(['filesystems.disks.s3.key' => 'invalid-key']);

// Now try to store - should fallback to local
$result = smart_storage()->store('test-fallback-file.txt', 'This is a fallback test file');
echo $result ? 'Success: File stored to local fallback' : 'Failed to store file';

// Check where it was actually stored
$localExists = Storage::disk('local')->exists('instasure/test-fallback-file.txt');
$s3Exists = Storage::disk('s3')->exists('instasure/test-fallback-file.txt');
echo "Local exists: " . ($localExists ? 'Yes' : 'No');
echo "S3 exists: " . ($s3Exists ? 'Yes' : 'No');
```

### Test 3: Check Synchronization Queue
```php
// Check what's in the sync queue
$queue = cache()->get('storage_sync_queue', []);
print_r($queue);

// Count files waiting for sync
count($queue);
```

### Test 4: Manual Synchronization
```php
// Restore proper S3 config first
config(['filesystems.disks.s3.key' => env('S3_KEY')]);

// Run synchronization manually
$results = smart_storage()->synchronize();
print_r($results);
```

### Test 5: Test URL Generation
```php
// Test URL generation (should return S3 URL if available, local if not)
$url = smart_storage()->url('test-file.txt');
echo "Generated URL: " . $url;
```

### Test 6: Simulate Complete S3 Failure
```php
// Simulate S3 connection failure by using invalid endpoint
config(['filesystems.disks.s3.endpoint' => 'https://invalid-s3-endpoint.com']);

// Check availability
$isAvailable = smart_storage()->isS3Available();
echo "S3 Available: " . ($isAvailable ? 'Yes' : 'No');

// Try to store file (should use local fallback)
$result = smart_storage()->store('user/admin/img/test-image.jpg', 'test image content');
echo $result ? 'Success: Used local fallback' : 'Complete failure';

// Restore proper config
config(['filesystems.disks.s3.endpoint' => env('S3_ENDPOINT')]);
```

### Test 7: Test Multiple Retries
```php
// Test the retry mechanism by temporarily making S3 fail
$originalKey = config('filesystems.disks.s3.key');
config(['filesystems.disks.s3.key' => 'invalid-key']);

// This should try S3, fail, then fallback to local
$result = smart_storage()->store('retry-test-file.txt', 'Testing retry mechanism');
echo $result ? 'Success after retry/fallback' : 'Failed completely';

// Restore config
config(['filesystems.disks.s3.key' => $originalKey]);
```

### Test 8: Verify Folder Structure
```php
// Test storing to different folders in the structure
$folders = [
    'user/admin/img/',
    'life_and_health/package/pkg_img/',
    'motor_insurance/claim/claim_file/',
    'travel_insurance/order/order_img/'
];

foreach ($folders as $folder) {
    $filename = $folder . 'test-file.txt';
    $result = smart_storage()->store($filename, "Test content for {$folder}");
    echo "{$filename}: " . ($result ? 'Success' : 'Failed') . "\n";
}
```

### Test 9: Check File Existence Across Disks
```php
// Check if a file exists on both storage systems
$filename = 'test-file.txt';

$s3Exists = Storage::disk('s3')->exists("instasure/{$filename}");
$localExists = Storage::disk('fallback')->exists($filename);

echo "S3 exists: " . ($s3Exists ? 'Yes' : 'No') . "\n";
echo "Local exists: " . ($localExists ? 'Yes' : 'No') . "\n";
```

### Test 10: Cleanup Test Files
```php
// Clean up test files from both storage systems
$testFiles = [
    'test-s3-file.txt',
    'test-fallback-file.txt',
    'test-file.txt',
    'retry-test-file.txt'
];

foreach ($testFiles as $file) {
    try {
        Storage::disk('s3')->delete("instasure/{$file}");
    } catch (Exception $e) {}
    
    try {
        Storage::disk('fallback')->delete($file);
    } catch (Exception $e) {}
}

echo "Test files cleaned up";
```

## Quick Test Commands (Copy-paste ready):

```php
// Quick availability check
smart_storage()->isS3Available();

// Quick storage test
smart_storage()->store('quick-test.txt', 'Testing storage system');

// Quick sync test
smart_storage()->synchronize();

// Quick URL test
smart_storage()->url('quick-test.txt');
```

These Tinker commands will help you thoroughly test the failover mechanism between S3 and local storage, including the synchronization functionality.
