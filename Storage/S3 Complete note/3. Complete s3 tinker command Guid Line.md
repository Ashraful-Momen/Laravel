# Complete S3 Tinker Commands Guide - Step by Step

## Prerequisites: Fixing Permission Issues First

### Step 1: Check Current Permissions
```bash
# Access your Docker container
docker exec -it $(docker ps -qf "name=app" | head -n1) bash

# Start tinker
php artisan tinker
```

```php
// Check directory permissions
file_exists('/var/www/html/public/instasure')
is_dir('/var/www/html/public/instasure')
is_writable('/var/www/html/public/instasure')

// Get detailed permission info
fileperms('/var/www/html/public/instasure')
posix_getpwuid(fileowner('/var/www/html/public/instasure'))
get_current_user()
exec('whoami')
exec('ls -la /var/www/html/public/ | grep instasure')

// Exit tinker
exit
```

### Step 2: Fix Permissions (if needed)
If you see `www` user but directory owned by `www-data`:

```bash
# Exit tinker and get root access
docker exec -it --user root $(docker ps -qf "name=app" | head -n1) bash

# Option 1: Change ownership to www user
chown -R www:www-data /var/www/html/public/instasure
chmod -R 775 /var/www/html/public/instasure

# Option 2: Add ACL permissions
setfacl -m u:www:rwx /var/www/html/public/instasure
setfacl -d -m u:www:rwx /var/www/html/public/instasure
getfacl /var/www/html/public/instasure

# Exit root and return as regular user
exit
```

### Step 3: Verify Permissions Fixed
```php
php artisan tinker

// Clear cache and test
clearstatcache();
is_writable('/var/www/html/public/instasure')
// Should return true

// Test fallback disk
Storage::disk('fallback')->put('test.txt', 'Hello World');
file_exists('/var/www/html/public/instasure/test.txt');
file_get_contents('/var/www/html/public/instasure/test.txt');
// Should show "Hello World"

exit
```

---

## Part 1: S3 Connection Testing

### Step 1: Basic Connection Test
```php
php artisan tinker

// Simple connection test
try {
    $result = Storage::disk('s3')->put('connection-test.txt', 'S3 Test - ' . now());
    echo $result ? "✅ S3 Upload Success\n" : "❌ S3 Upload Failed\n";
    Storage::disk('s3')->delete('connection-test.txt');
    echo "✅ S3 Connection Working!\n";
} catch (\Exception $e) {
    echo "❌ S3 Error: " . $e->getMessage() . "\n";
}
```

### Step 2: Verify S3 Configuration
```php
// Check S3 configuration
echo "🔧 S3 Configuration:\n";
$config = config('filesystems.disks.s3');
print_r($config);

// Check environment variables
echo "\n📋 Environment Variables:\n";
echo "S3_KEY: " . env('S3_KEY') . "\n";
echo "S3_BUCKET: " . env('S3_BUCKET') . "\n";
echo "S3_ENDPOINT: " . env('S3_ENDPOINT') . "\n";
echo "S3_REGION: " . env('S3_REGION') . "\n";
```

### Step 3: Test Read/Write Cycle
```php
// Complete read/write test
try {
    $testFile = 'test-' . time() . '.txt';
    $testContent = 'Read/Write test content';
    
    // Upload
    $uploaded = Storage::disk('s3')->put($testFile, $testContent);
    echo "Upload: " . ($uploaded ? '✅ Success' : '❌ Failed') . "\n";
    
    // Read back
    $retrieved = Storage::disk('s3')->get($testFile);
    echo "Content match: " . ($retrieved === $testContent ? '✅ Yes' : '❌ No') . "\n";
    
    // Delete
    Storage::disk('s3')->delete($testFile);
    echo "✅ Full cycle complete\n";
} catch (\Exception $e) {
    echo "❌ Error: " . $e->getMessage() . "\n";
}
```

---

## Part 2: File Management Operations

### Step 4: Count Files in Bucket
```php
// Count all files in bucket
$allFiles = Storage::disk('s3')->allFiles();
echo "📊 Total files in bucket: " . count($allFiles) . "\n";

// Count files in specific directories
$publicFiles = Storage::disk('s3')->allFiles('public');
echo "📂 Files in public/: " . count($publicFiles) . "\n";

$profileFiles = Storage::disk('s3')->allFiles('profile');
echo "📂 Files in profile/: " . count($profileFiles) . "\n";

$storageFiles = Storage::disk('s3')->allFiles('storage');
echo "📂 Files in storage/: " . count($storageFiles) . "\n";
```

### Step 5: List Files (Simple)
```php
// List first 10 files
$files = Storage::disk('s3')->allFiles();
echo "📄 First 10 files:\n";
foreach (array_slice($files, 0, 10) as $file) {
    echo "  - {$file}\n";
}

// List files in specific folder
$publicFiles = Storage::disk('s3')->files('public');
echo "\n📁 Direct files in public/ (not recursive):\n";
foreach ($publicFiles as $file) {
    echo "  - {$file}\n";
}
```

### Step 6: Tree Structure View
```php
// Simple tree view
function showS3Tree($path = '', $indent = '') {
    $dirs = Storage::disk('s3')->directories($path);
    $files = Storage::disk('s3')->files($path);
    
    // Show directories first
    foreach($dirs as $dir) {
        $dirName = basename($dir);
        echo $indent . "📁 {$dirName}/\n";
        // Recursive call with more indent
        showS3Tree($dir, $indent . "  ");
    }
    
    // Show files
    foreach($files as $file) {
        $fileName = basename($file);
        $size = Storage::disk('s3')->size($file);
        echo $indent . "📄 {$fileName} (" . number_format($size) . " bytes)\n";
    }
}

echo "🌳 S3 Bucket Structure:\n";
showS3Tree();
```

### Step 7: Detailed Tree with Stats
```php
// Enhanced tree with file counts
$allDirs = Storage::disk('s3')->allDirectories();
echo "📊 Directory Statistics:\n";
foreach($allDirs as $dir) {
    $dirFiles = Storage::disk('s3')->files($dir); // Direct files only
    $allDirFiles = Storage::disk('s3')->allFiles($dir); // All files recursively
    echo "📁 {$dir}/\n";
    echo "   Direct files: " . count($dirFiles) . "\n";
    echo "   Total files: " . count($allDirFiles) . "\n";
}
```

---

## Part 3: File Operations

### Step 8: Upload Files
```php
// Upload multiple test files
$testFiles = [
    'test/file1.txt' => 'Content 1',
    'test/file2.txt' => 'Content 2',
    'test/subdir/file3.txt' => 'Content 3'
];

foreach($testFiles as $path => $content) {
    $result = Storage::disk('s3')->put($path, $content);
    echo ($result ? "✅" : "❌") . " Uploaded: {$path}\n";
}
```

### Step 9: Check File Information
```php
// Get file metadata
$testFile = 'test/file1.txt';
if (Storage::disk('s3')->exists($testFile)) {
    $size = Storage::disk('s3')->size($testFile);
    $modified = Storage::disk('s3')->lastModified($testFile);
    $url = Storage::disk('s3')->url($testFile);
    
    echo "📋 File Info for {$testFile}:\n";
    echo "  Size: " . number_format($size) . " bytes\n";
    echo "  Modified: " . date('Y-m-d H:i:s', $modified) . "\n";
    echo "  URL: {$url}\n";
}
```

### Step 10: Download Files
```php
// Download and verify content
$filesToCheck = [
    'test/file1.txt' => 'Content 1',
    'test/file2.txt' => 'Content 2'
];

echo "📥 Downloading and verifying files:\n";
foreach($filesToCheck as $file => $expected) {
    if (Storage::disk('s3')->exists($file)) {
        $actual = Storage::disk('s3')->get($file);
        $match = trim($actual) === trim($expected);
        echo "  {$file}: " . ($match ? "✅ Content matches" : "❌ Content mismatch") . "\n";
    } else {
        echo "  {$file}: ❌ Not found\n";
    }
}
```

---

## Part 4: Storage Service Testing

### Step 11: Test StorageService
```php
// Test your custom StorageService
use App\Services\StorageService;

$storage = new StorageService();

// Check S3 availability
$s3Available = $storage->isS3Available();
echo "S3 Available: " . ($s3Available ? "✅ Yes" : "❌ No") . "\n";

// Test store with fallback
$testPath = 'service-test/file.txt';
$result = $storage->store($testPath, 'Service test content');
echo "Store via service: " . ($result ? "✅ Success" : "❌ Failed") . "\n";

// Get URL
$url = $storage->url($testPath);
echo "File URL: {$url}\n";
```

### Step 12: Check Sync Queue
```php
// Check files queued for sync
$syncQueue = Cache::get('storage_sync_queue', []);
echo "📋 Files in sync queue: " . count($syncQueue) . "\n";

if (!empty($syncQueue)) {
    foreach($syncQueue as $item) {
        echo "  - {$item['path']} (attempts: {$item['attempts']})\n";
        echo "    Added: " . $item['timestamp'] . "\n";
    }
}
```

---

## Part 5: Cleanup Operations

### Step 13: Delete Test Files
```php
// Clean up test files
$testFiles = [
    'test/file1.txt',
    'test/file2.txt',
    'test/subdir/file3.txt',
    'service-test/file.txt'
];

echo "🗑️ Cleaning up test files:\n";
foreach($testFiles as $file) {
    if (Storage::disk('s3')->exists($file)) {
        $deleted = Storage::disk('s3')->delete($file);
        echo "  {$file}: " . ($deleted ? "✅ Deleted" : "❌ Failed") . "\n";
    } else {
        echo "  {$file}: Already gone\n";
    }
}

// Delete empty test directories
Storage::disk('s3')->deleteDirectory('test');
echo "✅ Test directory cleaned\n";
```

### Step 14: Final Status Check
```php
// Final bucket summary
echo "\n📊 FINAL BUCKET STATUS:\n";
echo "========================\n";

$allFiles = Storage::disk('s3')->allFiles();
$totalSize = 0;
foreach($allFiles as $file) {
    $totalSize += Storage::disk('s3')->size($file);
}

echo "Total Files: " . count($allFiles) . "\n";
echo "Total Size: " . number_format($totalSize / 1024 / 1024, 2) . " MB\n";

// Group by directory
$byDir = [];
foreach($allFiles as $file) {
    $dir = dirname($file);
    if ($dir === '.') $dir = 'root';
    $byDir[$dir] = ($byDir[$dir] ?? 0) + 1;
}

echo "\nFiles by directory:\n";
foreach($byDir as $dir => $count) {
    echo "  📁 {$dir}: {$count} files\n";
}
```

---

## Part 6: Quick Diagnostic Commands

### All-in-One Health Check
```php
// Quick health check function
function s3HealthCheck() {
    echo "🔍 S3 HEALTH CHECK\n";
    echo "==================\n";
    
    // 1. Connection test
    try {
        Storage::disk('s3')->put('health.txt', 'OK');
        Storage::disk('s3')->delete('health.txt');
        echo "✅ Connection: Working\n";
    } catch (\Exception $e) {
        echo "❌ Connection: Failed\n";
        return;
    }
    
    // 2. Bucket access
    try {
        $files = count(Storage::disk('s3')->allFiles());
        echo "✅ Bucket Access: OK ({$files} files)\n";
    } catch (\Exception $e) {
        echo "❌ Bucket Access: Failed\n";
    }
    
    // 3. Configuration
    echo "📋 Config:\n";
    echo "  Bucket: " . env('S3_BUCKET') . "\n";
    echo "  Endpoint: " . env('S3_ENDPOINT') . "\n";
    echo "  Region: " . env('S3_REGION') . "\n";
    
    // 4. Fallback status
    $storage = new \App\Services\StorageService();
    $s3Available = $storage->isS3Available();
    echo "🔄 Fallback: " . ($s3Available ? "Not needed" : "Active") . "\n";
    
    echo "==================\n";
    echo "✅ Check Complete\n";
}

// Run the health check
s3HealthCheck();
```

### Quick Stats Function
```php
// Quick stats function
function s3Stats() {
    $files = Storage::disk('s3')->allFiles();
    $dirs = Storage::disk('s3')->allDirectories();
    $size = array_sum(array_map(fn($f) => Storage::disk('s3')->size($f), $files));
    
    echo "📊 S3 Stats: ";
    echo count($files) . " files, ";
    echo count($dirs) . " dirs, ";
    echo number_format($size / 1024 / 1024, 1) . " MB\n";
}

s3Stats();
```

---

## Exit Tinker
```php
// When done, exit tinker
exit
```

---

## Useful Bash Aliases

Add these to your `.bashrc` for quick access:

```bash
# Quick tinker access
alias tinker='docker exec -it $(docker ps -qf "name=app" | head -n1) php artisan tinker'

# S3 test command
alias s3test='docker exec -it $(docker ps -qf "name=app" | head -n1) php artisan storage:sync'

# Fix permissions
alias fixperms='docker exec -it --user root $(docker ps -qf "name=app" | head -n1) bash -c "chown -R www:www-data /var/www/html/public/instasure && chmod -R 775 /var/www/html/public/instasure"'
```

---

## Common Issues & Solutions

### Issue 1: Permission Denied
```php
// In tinker
clearstatcache();
exec('whoami');  // Check user
fileowner('/var/www/html/public/instasure');  // Check owner
```

### Issue 2: S3 Connection Failed
```php
// Check credentials
env('S3_KEY');
env('S3_SECRET');
env('S3_ENDPOINT');

// Test with AWS CLI (if available)
exec('aws s3 ls s3://' . env('S3_BUCKET'));
```

### Issue 3: Files Not Syncing
```php
// Check sync queue
Cache::get('storage_sync_queue');

// Run sync manually
$storage = new \App\Services\StorageService();
$result = $storage->synchronize();
print_r($result);
```

---

## Summary Commands Cheat Sheet

```php
// Most used commands - copy/paste ready

// 1. Quick test
Storage::disk('s3')->put('test.txt', 'test'); Storage::disk('s3')->delete('test.txt');

// 2. Count files
count(Storage::disk('s3')->allFiles())

// 3. List files
array_slice(Storage::disk('s3')->allFiles(), 0, 10)

// 4. Check specific file
Storage::disk('s3')->exists('path/to/file.txt')

// 5. Get file URL
Storage::disk('s3')->url('path/to/file.txt')

// 6. Check sync queue
Cache::get('storage_sync_queue')

// 7. Test fallback
Storage::disk('fallback')->put('test.txt', 'test')

// 8. Clear cache
clearstatcache()
```
